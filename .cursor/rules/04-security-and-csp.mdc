---
globs: middleware.ts, app/layout.tsx, app/GoogleScripts.tsx, components/partials/JsonLdServer.tsx, proxy.ts
alwaysApply: false
---

### Security: CSP and JSON-LD (relaxed policy with host allowlisting)

- **CSP**: Relaxed policy with host allowlisting (configured in `proxy.ts`). Allows `'unsafe-inline'` for inline scripts and JSON-LD to enable ISR/PPR caching. Google Analytics, Ads, and trusted domains (googletagmanager.com, google-analytics.com, googlesyndication.com, etc.) are allowlisted in `script-src` and `script-src-elem`. **No nonce required**—scripts work without nonce props.
- **JSON-LD**: Server-rendered via `JsonLdServer` component (`components/partials/JsonLdServer.tsx`). Escapes `</script>` and `<` to prevent XSS. Data comes from server-side API responses, not user input. No nonce required due to relaxed CSP.
- **External tracking**: Load GA/Ads/Sentry via Next.js `<Script>` component with `strategy="afterInteractive"`. No nonce props needed.
- **API security**: Internal API routes (`app/api/*`) handle HMAC signing server-side via `*-external.ts` wrappers using `fetchWithHmac`. Middleware enforces HMAC on most `/api/*` routes; public GET endpoints (events, news, categories, places, regions, cities) are allowlisted. Never sign requests in the browser—always use internal API routes.
- **Headers**: Security headers set in `middleware.ts`; do not duplicate in Next `headers()` config.
- **Rationale**: For a cultural events site with HMAC-protected backend, relaxed CSP enables better performance (ISR/PPR) while maintaining security through host allowlisting.
