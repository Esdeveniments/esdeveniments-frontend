---
alwaysApply: false
---

### URL parsing and canonicalization

- **Parsing**: Use `parseFiltersFromUrl`, `urlToFilterState` from `utils/url-filters.ts` and `utils/url-parsing.ts`.
- **Canonical normalization**: Use `getRedirectUrl(parsed)` or `buildCanonicalUrl` and `redirect(canonicalUrl)`; never implement string logic manually.
- **Proxy redirects**: `proxy.ts` calls `handleCanonicalRedirects` (`utils/middleware-redirects.ts`) to redirect non-canonical URLs to canonical form:
  - Legacy query params (`?category=X&date=Y`) → canonical path segments (`/place/date/category`)
  - `/tots` in path segments → omitted in canonical URLs (e.g., `/place/tots/category` → `/place/category`)
  - Preserves unrelated query params (e.g., `search`, `distance`, `lat`, `lon`) during redirects
  - Returns 301 permanent redirects for SEO
- **Segments vs query**:
  - Segments: `place`, `byDate`, `category` (with omission rules)
  - Query: `search`, `distance`, `lat`, `lon`
- **Dynamic categories**: pass fetched categories to parser so it can validate slugs; fallback to legacy mapping.
- **2-segment interpretation**: `/place/foo` may be date or category; rely on `isValidDateSlug` and dynamic categories to decide.
- **Validation**: `validatePlaceOrThrow` and `validatePlaceForMetadata` in `utils/route-validation.ts` must be used.
