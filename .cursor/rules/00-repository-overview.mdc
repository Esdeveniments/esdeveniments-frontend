# Repository overview and always-load context

- Primary sources to consult first:
  - `.github/copilot-instructions.md` (authoritative architecture and domain rules)
  - `project-snapshot.txt` (point-in-time config and script snapshot)
  - `types/README.md` (type organization and canonical sources)
- Core stack: Next.js 16 App Router + React 19 + TypeScript; Node >=22, Yarn 4.12. URL-first filtering system, SSR + client enhancement (hybrid rendering), SW for offline/caching, relaxed CSP with host allowlisting (inline scripts/JSON-LD allowed; nonce optional), design system with semantic Tailwind classes, and `next-intl` for i18n (plugin enabled).

- Key domains:
  - Filters & URLs: `config/filters.ts`, `utils/url-filters.ts`, `utils/url-parsing.ts`, `utils/filter-operations.ts`
  - API & caching: `lib/api/*`, `lib/api/cache.ts`
  - Security: `proxy.ts` (CSP, headers), `app/layout.tsx`, `app/GoogleScripts.tsx`
  - SEO: `components/partials/seo-meta.ts`, `lib/meta.ts`, page `generateMetadata`
  - Rendering: `components/ui/hybridEventsList`, `components/ui/clientInteractiveLayer`
  - SW: `public/sw-template.js`, `scripts/generate-sw.mjs`
  - Images: `utils/image-quality.ts`, `utils/image-preload.ts`, `components/hooks/useImageRetry.ts`
  - Types: `types/common.ts` (shared UI types), `types/api/*.ts` (API DTOs), `types/README.md` (organization guide)
  - Design System: `docs/implementation-reference.md` (canonical code), `docs/design-system-overview.md` (WHAT & WHY), `docs/reference-data.md` (lookup tables)
  - i18n: `i18n/routing.ts`, `i18n/request.ts`, `types/i18n.ts`, `messages/*.json`; NextIntlClientProvider in `app/layout.tsx`; locale header from `proxy.ts` (`x-next-intl-locale`).

## Start-of-prompt checklist (use every time)

- Identify the domain of the request and open the relevant files above.
- Re-read invariants in `.github/copilot-instructions.md` sections 2, 3, 4, 6, 7, 8, 13, 15.
- Respect canonical URL rules and the config-driven filters. Never hand-craft URLs.
- For data fetching, follow env-guard + safe-fallback policy and keep backend param names identical.
- Scripts/JSON-LD: relaxed CSP allows inline; nonce not required. If you already read `nonce` from `headers()`, you may pass it, but itâ€™s optional.
- Design System guardrails: use semantic classes for typography, buttons, cards, badges, containers; forbid `gray-*`; follow phased enforcement (see docs).
- If ads/events lists are touched, follow the Hybrid Rendering Contract (SSR inserts ads, client does not).
- If SW behavior is affected, edit `public/sw-template.js` and regenerate via `scripts/generate-sw.mjs`.
- For type changes: Check `types/README.md` for canonical sources and avoid duplication.

## Non-negotiable invariants

- Filters are configuration-driven. Defaults and removal logic live in `FilterOperations` and config, not scattered conditionals.
- Canonical omission rules for `tots` segments must be preserved. Use helpers in `utils/url-filters.ts`.
- All read endpoints must return safe fallbacks when `NEXT_PUBLIC_API_URL` is absent or fetch fails.
- CSP is relaxed with host allowlisting; inline scripts/JSON-LD are allowed without a nonce. Only pass a nonce if you already have it from `headers()`.
- Constants belong in `utils/constants.ts`. Types/interfaces live under `types/`.
- Type organization: Each type has exactly one canonical source. Import from canonical locations, never duplicate.

## Quick links

- Filters: `config/filters.ts`, `utils/filter-operations.ts`, `utils/url-filters.ts`, `utils/url-parsing.ts`
- API: `lib/api/events.ts`, `lib/api/categories.ts`, `lib/api/regions.ts`, `lib/api/cities.ts`, `lib/api/places.ts`, `lib/api/cache.ts`
- Security: `proxy.ts`, `app/layout.tsx`, `app/GoogleScripts.tsx`
- SEO: `components/partials/seo-meta.ts`, `lib/meta.ts`
- SW: `public/sw-template.js`, `scripts/generate-sw.mjs`
- Tests: `test/filter-system.test.ts`, `test/setup.ts`
- Types: `types/common.ts`, `types/api/*.ts`, `types/README.md`
