<?xml version='1.0' encoding='utf-8'?>
<source type="github_repository"><commit>unknown</commit><file name=".lighthouserc.json">{ "ci": { "collect": { "url": ["http://localhost:3000/", "http://localhost:3000/catalunya"], "numberofruns": 3, "startservercommand": "yarn start -p 3000", "startserverreadypattern": "ready", "chromeflags": "--no-sandbox --disable-dev-shm-usage", "settings": { "preset": "desktop", "extraheaders": { "accept-language": "ca" } } }, "assert": { "assertions": { "categories:performance": ["error", { "minscore": 0.45 }], "largest-contentful-paint": ["error", { "maxnumericvalue": 5000 }], "cumulative-layout-shift": ["error", { "maxnumericvalue": 0.25 }], "categories:accessibility": ["warn", { "minscore": 0.8 }], "categories:best-practices": ["warn", { "minscore": 0.8 }], "categories:seo": ["warn", { "minscore": 0.8 }] } }, "upload": { "target": "temporary-public-storage" } } }</file><file name=".nvmrc">22</file><file name=".yarnrc.yml">nodelinker: node-modules yarnpath: .yarn/releases/yarn-4.12.0.cjs packageextensions: "@sentry/nextjs@*": peerdependencies: "@opentelemetry/api": "*" "@opentelemetry/context-async-hooks": "*" "@opentelemetry/core": "*" "@opentelemetry/sdk-trace-base": "*" react: "*" # webpack provided next.js internally, need install webpack: "*" "@types/react-datepicker@*": peerdependencies: react: "*" react-dom: "*"</file><file name="AGENTS.md"># repository guidelines ## project structure &amp; module organization - `app/` next.js app router (layouts, routes, api `app/api`). example: `app/[place]/page.tsx`. - `components/` reusable ui (`ui/`, `partials/`, `hooks/`). prefer feature folders `components/ui/...`. - `lib/`, `utils/` shared logic; `config/` app config; `types/` canonical typescript types. - `public/` static assets; `styles/` tailwind; `docs/` notes; `scripts/` build utilities (e.g., `generate-sw.mjs`). - `test/` unit/integration (vitest); `e2e/` playwright. - path aliases `tsconfig.json` (e.g., `@components/*`, `@utils/*`). ## build, test, development commands - `yarn dev` start local dev (runs prebuild: service worker generation). - `yarn build` production build; `postbuild` runs `next-sitemap`. - `yarn start` serve built app; `yarn lint` eslint; `yarn typecheck` ts noemit. - `yarn test` vitest; `yarn test:watch`; `yarn test:coverage`. - `yarn test:e2e` playwright; `yarn test:e2e:ui` ui runner. remote: `playwright.remote.config.ts` `playwright_test_base_url`. - extras: `yarn analyze` bundle analysis; `yarn scan` run reactscan `localhost:3000`. - ci: amplify builds use node 20 + yarn 4; prebuild generates `public/sw.js` postbuild runs sitemap. ## coding style &amp; naming conventions - typescript strict; prefer server components default. add `"use client"` needed. - eslint extends `next/core-web-vitals` + ts + `@eslint-react`. fix warnings merge. - define type aliases/interfaces `types/` (eslintenforced). - components: pascalcase; hooks: `usexxx`; helpers: lowercamelcase. - indentation: 2 spaces; prefer path aliases; tailwind utilities styling; globals `styles/`. ## react hooks best practices - **useref vs usestate tracking flags**: use `useref` `usestate`) one-time tracking flags affect rendering (e.g., analytics fired, effect ran). ref update trigger re-render. - `const hastracked = useref(false)` - analytics, one-time effects - `const [hastracked, sethastracked] = usestate(false)` - causes unnecessary re-render - **dependency arrays**: refs need dependency arrays stable). include values trigger effect. - **memoization**: use `usememo` expensive computations, `usecallback` callbacks passed children. over-optimizeprofile first. ## testing guidelines - unit tests: vitest + jsdom; react testing library. files: `test/**/*.{test,spec}.{ts,tsx}`. - aim meaningful coverage new code (`yarn test:coverage`). - e2e: playwright `e2e/`. local config starts app; remote config targets existing url via `playwright_test_base_url`. - test bootstrap: `test/setup.ts` seeds `hmac_secret` hmac utilities. ## commit &amp; pull request guidelines - conventional commits: `feat:`, `fix:`, `chore:`, `docs:`, `test:`, `refactor:`. use scope helpful (e.g., `feat(ui): sharebutton`). - keep messages imperative specific; avoid `wip` mainline branches. - prs include: summary, linked issues, screenshots ui, test plan. - run `yarn lint &amp;&amp; yarn typecheck &amp;&amp; yarn test` e2e relevant) pushing. - branching: use shortlived `feat/*` `fix/*` branches; target default branch `develop` active). ## security &amp; configuration tips - never commit secrets. use `.env.development`, `.env.staging`, `.env.production` (loaded via `env-cmd`). - `next_public_api_url` influences service worker (generated `public/sw-template.js`) tests. changes, rerun prebuild/dev. - sentry configured (`sentry.*.config.ts`); set dsn nonlocal environments. - yarn 4 workspace; prefer `yarn` `npm`. - csp: relaxed policy host allowlisting (see `proxy.ts`). allows `'unsafe-inline'` inline scripts/json-ld enable isr/ppr caching. google analytics, ads, trusted domains allowlisted. nonce required. - api security: internal api proxy layer (`app/api/*`) handles hmac signing server-side via `*-external.ts` wrappers using `fetchwithhmac`. client libraries call internal routes, never external api directly. middleware enforces hmac `/api/*` routes; public endpoints (get events, news, categories, etc.) allowlisted. - **fetch best practices**: never use raw `fetch()` without timeout response validation. use `fetchwithhmac` internal api calls built-in 10s timeout), `safefetch`/`fireandforgetfetch` `utils/safe-fetch.ts` external webhooks/services (5s default timeout, response validation, sentry logging). ## agent-specific instructions - prefer surgical diffs; keep file moves/renames minimal scoped. - edit generated build output (`public/sw.js`, `.next/**`, `tsconfig.tsbuildinfo`, `server-place-sitemap.xml`). edit `public/sw-template.js` run prebuild instead. - types live `types/`; avoid redefining `navigationitem`, `sociallinks`, `eventprops`, `citysummaryresponsedto` (see `types/common.ts`, `types/api/city.ts`). - reusable/derived props types (e.g., picks existing props interface) must declared `types/` (typically `types/props.ts`) rather inline within components. - introducing new type/interface, search `types/` related feature folders) existing candidates reuse/extend, place additions appropriate shared file (e.g., `types/props.ts` ui props, `types/api/*` dtos). - server-first default; mark client components `"use client"` necessary. avoid exposing secrets client code. - api security: internal api routes (`app/api/*`) handle hmac signing server-side via `*-external.ts` wrappers. middleware enforces hmac `/api/*` routes; public get endpoints (events, news, categories, places, regions, cities) allowlisted. never sign requests browseralways use internal api routes. - use yarn 4 commands node 20 locally; run `yarn lint &amp;&amp; yarn typecheck &amp;&amp; yarn test` finalizing changes. ## architecture overview - next.js app router serverfirst rendering; client state via zustand (`store.ts`) client data fetching via swr. - api layer: internal proxy patternclient libraries (`lib/api/*`) call internal next.js api routes (`app/api/*`) proxy external backend via `*-external.ts` wrappers hmac signing. - seo &amp; sitemaps: `next-sitemap` runs build; sitemap routes `app/`; `middleware.ts` handles edge behavior, canonical redirects, csp. - url canonicalization: middleware automatically redirects legacy query params `/tots` segments canonical paths (301 redirects). ## critical: isr/caching cost prevention **never add `searchparams` page components `app/[place]/` routes.** reading `searchparams` page component makes page **dynamic**, causing opennext/sst create separate dynamodb cache entry every unique url+query combination. caused **$300+ cost spike** dec 28, 2025. **rules:** 1. listing pages (`app/[place]/*`) must read `searchparams` - keep static (isr) 2. query params (`search`, `distance`, `lat`, `lon`) handled **client-side via swr 3. seo robots `noindex` filtered urls handled via `x-robots-tag` header `proxy.ts` 4. cloudwatch alarm `dynamodb-highwritecost-alert` monitors write spikes &gt;100k/hour need query-dependent behavior:** - handle middleware (`proxy.ts`) headers/redirects - handle client-side data fetching - never make page component read `searchparams` ## local setup - requirements: node 20, yarn 4.9+ (use corepack). - install: `corepack enable &amp;&amp; corepack prepare yarn@4.9.1 --activate &amp;&amp; yarn install --immutable`. - env: set `hmac_secret` (serveronly), `next_public_api_url` (defaults handled), optional `next_public_google_analytics`, `next_public_google_ads`, `sentry_dsn`. - run: `yarn dev` (generates `public/sw.js` via prebuild). build: `yarn build`. - tests: `yarn test`; e2e: `yarn test:e2e` (local config starts app). ## feature checklist - types: add/extend `types/` inline app/component types). - ui/pages: place components `components/ui/&lt;feature&gt;/`; routes `app/&lt;segment&gt;/` (serverfirst; add `"use client"` needed). - api: call server code via internal api routes (`app/api/*`); proxy external backend hmac. use query builders (`buildeventsquery`, `buildnewsquery`) `utils/api-helpers.ts`. respect hmac middleware; public get endpoints allowlisted. - tests: add unit tests `test/` e2e flows `e2e/` uservisible. - sw/caching: adding external api usage offline behavior, edit `public/sw-template.js` rerun prebuild/dev. - prepr: `yarn lint &amp;&amp; yarn typecheck &amp;&amp; yarn test` e2e applicable); include screenshots ui.</file><file name="README.md"># que fer next.js app productionready next.js 16.1 + typescript app using app router. includes tailwindcss, swr, zustand, vitest, playwright, sentry, workboxbased service worker. contribution rules, see agents.md. ## quickstart 1. requirements: node 20 yarn 4 (corepack) ```bash corepack enable &amp;&amp; corepack prepare yarn@4.9.1 --activate yarn install --immutable ``` 1. environment create `.env.development` set ci/hosting others): - hmac_secret=your-server-secret - next_public_api_url=`https://api-pre.esdeveniments.cat` prod) - optional: next_public_google_analytics, next_public_google_ads, sentry_dsn 1. run ```bash yarn dev # build: generates sw, builds app, sitemaps yarn build &amp;&amp; yarn start ``` ## scripts - dev: start next.js (prebuild generates `public/sw.js` `public/sw-template.js`) - dev:inspect: start next.js node.js debugger enabled (`next dev --inspect`) - build/start: production build serve; postbuild runs `next-sitemap` - lint/typecheck: eslint `tsc --noemit` - test/test:watch/test:coverage: vitest (jsdom, rtl) - test:e2e, test:e2e:ui, test:e2e:debug: playwright - analyze, analyze:browser, analyze:server: bundle analysis @next/bundle-analyzer - analyze:experimental: next.js 16.1 experimental bundle analyzer (interactive ui turbopack) - upgrade: upgrade next.js latest version using `next upgrade` - scan: react-scan localhost ## structure - app/ (routes, layouts, api app/api) - components/ (ui/, partials/, hooks/) - lib/, utils/, config/, types/ - styles/, public/, scripts/ (e.g., `generate-sw.mjs`), docs/ - test/ (vitest), e2e/ (playwright) - path aliases tsconfig: `@components/*`, `@utils/*`, etc. - next.js 16 note: old `middleware.ts` `proxy.ts`; keep locale detection, canonical redirects, csp, cache headers centralized ## testing - unit/integration: `yarn test`; coverage: `yarn test:coverage` - e2e local: `yarn test:e2e` (starts dev server) - e2e remote: use `playwright.remote.config.ts` `playwright_test_base_url` ## bundle size regressions ci enforces bundle-size regression gate `yarn build`. - baseline + thresholds: `bundle-size-baseline.json` - current report (generated): `bundle-sizes.json` run locally: ```bash yarn build node scripts/analyze-bundles-cli.mjs --format json &gt; bundle-sizes.json node scripts/compare-bundle-sizes.mjs --baseline bundle-size-baseline.json --current bundle-sizes.json ``` update baseline increase intentional): 1) run commands 2) copy updated numbers `bundle-sizes.json` `bundle-size-baseline.json` 3) bump `lastupdated` ## security &amp; api - internal api proxy layer: client libraries (`lib/api/*`) call internal next.js api routes (`app/api/*`) proxy external backend hmac signing via `*-external.ts` wrappers. never call external api directly pages/components. - middleware enforces hmac `/api/*` routes (`x-hmac`, `x-timestamp`); public get endpoints (events, news, categories, places, regions, cities) allowlisted. avoid signing browseralways use internal api routes. - csp: relaxed policy host allowlisting google analytics, ads, trusted domains. inline scripts allowed via `'unsafe-inline'` enable isr/ppr caching. json-ld rendered server-side via `jsonldserver` component. see `proxy.ts` full csp configuration. ## next.js 16.1 features - **turbopack file system caching**: enabled default `next dev` faster compile times, especially restarts large projects. - **experimental bundle analyzer**: use `yarn analyze:experimental` launch interactive ui analyzing production bundles turbopack integration. - **improved debugging**: use `yarn dev:inspect` enable node.js debugger easier debugging. - **improved `serverexternalpackages`**: turbopack correctly handles transitive dependencies without additional configuration. ## deploy - aws amplify config (`amplify.yml`) uses node 20 + yarn 4, immutable installs, prebuild sw generation, next sitemap postbuild. set environment variables hosting.</file><file name="README_INFRA.md"># infrastructure &amp; deployment (aws/sst) **date:** december 1, 2025 **status:** migrated vercel aws (sst) ## stack (high level) moved away vercel self-hosted serverless architecture aws using **sst (ion/v3)**. gives us full control, lower costs, "always-on" performance. | component | technology | details | | :-------------- | :----------------- | :---------------------------- | | **framework** | next.js (opennext) | running `standalone` mode | | **compute** | aws lambda | `eu-west-3` (paris) | | **cdn** | aws cloudfront | global edge caching | | **deploy tool** | sst v3 (ion) | infrastructure code (iac) | | **dns** | cloudflare | proxies traffic cloudfront | --- ## works ### 1. request flow `user (browser)` -&gt; `cloudflare (dns/waf)` -&gt; `aws cloudfront (cdn)` -&gt; `aws lambda (server)` ### 2. environments use **single aws account** separate resources. - **production (`www`)**: live site. - **staging (`pre`)**: points production infrastructure uses `pre.esdeveniments.cat` domain. - _note:_ `pre` hidden google via middleware (`x-robots-tag: noindex`). ### 3. configuration (`sst.config.ts`) infrastructure defined code. key optimizations applied: - **warm instances (`warm: 5`):** keeps 5 server instances awake 24/7 prevent "cold starts." - **memory (`3008 mb`):** 3 gb memory = **3 vcpus** (aws lambda maximum arm64 architecture eu-west-3). - **architecture (`arm64`):** uses aws graviton processors (cheaper &amp; faster x86). --- ## development &amp; deployment ### environment variables github actions (ci/cd):** - workflow automatically creates `.env.production` github secrets - manual `.env` file management needed local development:** - uses `.env.local` local dev server (`yarn dev`) - manual deployments, need `.env.production` root ### deploying production #### automatic deployment (recommended) **automatic deployment happens via github actions** push merge `main`: 1. **cleans build cache** - removes stale `.next`, `.sst`, `.open-next` directories 2. **creates `.env.production`** - builds environment file github secrets validation 3. **validates required secrets** - fails fast `next_public_api_url`, `hmac_secret`, `sentry_dsn` missing 4. **builds next.js app** - runs production build correct environment variables 5. **deploys aws** - updates lambda functions, cloudfront, s3 assets 6. **invalidates cache** - ensures users get latest version **workflow:** `.github/workflows/deploy-sst.yml` manual steps required!** merge `main` deployment happens automatically. #### manual deployment (local) manual deployments local machine: ```bash # ensure .env.production required variables npx sst deploy --stage production ``` **note:** workflow sets `node_env=production`, next.js automatically loads `.env.production` build. --- ## critical maintenance notes ### 1. image optimization use dedicated lambda `next/image`. - **fixing 403 errors:** images break, check `siteimageoptimizerfunction` aws lambda console. must **function url** enabled `auth: none` permission policy allowing `*` `invokefunctionurl`. #### image caching strategy use **aggressive 1-year cloudfront ttl** (`minimumcachettl: 31536000` `next.config.js`) minimize lambda invocations reduce costs. cache-busting handled via url query parameters (`?v=&lt;key&gt;`) rather relying short ttls. works:** 1. **cache key generation:** images receive cache-busting query parameters based content: - **news images:** `updatedat || slug || id` (see `utils/news-cache.ts`) - **event images:** `hash || updatedat` (see `lib/validation/event.ts`) - **cloudinary uploads:** `public_id` (see `components/ui/restaurantpromotion/cloudinaryuploadwidget.tsx`) 2. **url transformation:** `withimagecachekey()` function `utils/image-cache.ts` appends `?v=&lt;key&gt;` image urls. image updated: - cache key changes (e.g., `updatedat` timestamp updates) - url changes (e.g., `image.jpg?v=old-key` `image.jpg?v=new-key`) - cloudfront treats new resource fetches updated image 3. **benefits:** - **performance:** long ttl means images served cloudfront edge locations globally - **cost:** fewer lambda invocations image optimization - **reliability:** updates immediate waiting cache expiration) maintainers:** - updating images, ensure source data (event `hash`, news `updatedat`, cloudinary `public_id`) changes - cache-busting happens automatically via normalization functions `lib/api/*` `utils/news-cache.ts` - images update changes, verify cache key source field updated api response ### 2. "6mb trap" aws lambda hard limit **6mb** request/response bodies. - send large files api routes. use s3 presigned urls uploads. - return massive json objects (&gt;5mb) api routes. always paginate. ### 3. middleware &amp; indexing use `middleware.ts` block search engines `pre` subdomain. - see `x-robots-tag: noindex` production, something wrong `host` check middleware. ### 4. cloudfront settings (manual) settings managed manually aws console sst expose yet): - **http/3:** enabled manually cloudfront distribution settings -&gt; "supported http versions" -&gt; "http/2 http/3". ### 5. uptime monitoring automated uptime monitor runs every 15 minutes via github actions (`.github/workflows/uptime.yml`). - checks:** http status code (must 200) page content (must contain "esdeveniments.cat") - **email alerts:** configured send email notifications site - **required github secrets:** - `smtp_server`: smtp server address (e.g., `smtp.gmail.com` `email-smtp.eu-west-3.amazonaws.com` aws ses) - `smtp_port`: smtp port (typically `587` tls `465` ssl) - `smtp_username`: smtp username/access key - `smtp_password`: smtp password/secret key - `smtp_from`: email address send (e.g., `alerts@esdeveniments.cat`) - `uptime_alert_email`: email address(es) receive alerts (comma-separated multiple recipients) **setting email notifications:** 1. choose smtp provider (gmail, aws ses, sendgrid, etc.) 2. configure secrets github: **settings** **secrets variables** **actions** 3. test manually triggering workflow: **actions** **uptime monitor** **run workflow** **note:** aws ses, need verify sender recipient email addresses ses console emails sent. #### aws cloudwatch alarms (native aws monitoring) addition github actions uptime monitor, set aws-native alarms faster detection: **existing alarms (configured `sst.config.ts`):** - **lambda errors alarm**: alerts lambda function errors exceed 10 1 minute - **lambda throttling alarm**: alerts lambda throttles exceed 5 1 minute - **sns topic**: alarms send email `alarm_email` (defaults `esdeveniments.catalunya.cat@gmail.com`) add cloudfront 5xx error alarm (website detection):** 1. **get cloudfront distribution id:** - aws console cloudfront distributions - find distribution `esdeveniments.cat` - copy distribution id (starts `e...`) 2. **create cloudwatch alarm:** - aws console cloudwatch alarms create alarm - **metric:** `aws/cloudfront` `5xxerrorrate` - **dimensions:** select cloudfront distribution id - **statistic:** `average` - **period:** `5 minutes` - **threshold:** `greater 0` (alert 5xx errors) - **sns topic:** select `sitealarms` topic (created sst) - **alarm name:** `cloudfront-5xx-errors` 3. **optional: cloudwatch synthetics canary (comprehensive uptime check):** - aws console cloudwatch synthetics create canary - **template:** `heartbeat monitoring` - **url:** `https://www.esdeveniments.cat` - **frequency:** `every 5 minutes` - **alarm:** create alarm canary fails select `sitealarms` sns topic **benefits aws alarms:** - **faster detection**: alarms trigger immediately (vs 15-minute github actions) - **multiple channels**: add sms, slack, pagerduty integrations sns topic - **better visibility**: cloudwatch dashboards show historical uptime trends - **cost**: cloudwatch alarms free; synthetics canary costs ~$0.0012 per run (~$0.10/month) --- ## on-demand cache revalidation adding new towns/places backend, use `/api/revalidate` endpoint immediately clear caches. ### gets cleared | cache layer | mechanism | |-------------|-----------| | **next.js data cache** | `revalidatetag()` | | **lambda in-memory cache** | `clearplacescaches()`, etc. | | **cloudflare cdn** | api prefix purge configured) | ### usage ```bash curl -x post https://www.esdeveniments.cat/api/revalidate \ -h "content-type: application/json" \ -h "x-revalidate-secret: your_revalidate_secret" \ '{"tags": ["places", "regions", "regions:options", "cities"]}' ``` ### response ```json { "revalidated": true, "tags": ["places", "regions", "regions:options", "cities"], "cloudflare": { "purged": true, "prefixes": ["/api/places", "/api/regions", "/api/regions/options", "/api/cities"] }, "timestamp": "2025-12-07t08:00:00.000z" } ``` ### allowed tags tags revalidated (security whitelist): - `places` - place data - `regions` - region list - `regions:options` - region/city dropdown data - `cities` - city list - `categories` - category list ### setting cloudflare token 1. go [cloudflare dashboard](https://dash.cloudflare.com) profile** **api tokens** 2. click **create token** 3. use template: **custom token** 4. permissions: **zone** **cache purge** **purge** 5. zone resources: **include** **specific zone** `esdeveniments.cat` 6. click **create token** copy --- ## troubleshooting | problem | cause | fix | | :----------------------- | :----------------- | :------------------------------------------------------------------------------------------------ | | **images 403 forbidden** | lambda permissions | go aws lambda -&gt; `imageoptimizer` -&gt; add permission `invokefunctionurl` principal `*`. | | **site "looping"** | cloudfront origin | ensure cloudflare points **cloudfront url** (`d123...cloudfront.net`), lambda url. | | **slow initial load** | cold start | check `sst.config.ts` `warm: 5`. check aws lambda "provisioned concurrency" metrics. | | **env vars missing** | build process | deploy without `.env`? re-run `npx sst deploy`. | | **api returns "unauthorized"** | secret deployed | add secret github secrets `deploy-sst.yml`. see checklist | | **robots.txt returns 403** | opennext routing priority | see [robots.txt issues documentation](../docs/robots-txt-issues.md) complete troubleshooting guide. | &gt; ** detailed documentation:** complete `robots.txt` troubleshooting journey, including three issues encountered final workaround, see [`docs/robots-txt-issues.md`](../docs/robots-txt-issues.md). --- ## github secrets setup ci/cd) automatic deployment work, configure secrets github: &gt; [!important] &gt; adding new runtime environment variables**, must &gt; 1. add secret github: **settings secrets actions new secret** &gt; 2. update `.github/workflows/deploy-sst.yml` include secret env block write `.env.production` &gt; &gt; missing either step cause variable undefined runtime! ### required secrets | secret name | description | example value | | ------------------------ | ------------------------------------------------ | --------------------------------------- | | `aws_access_key_id` | aws iam user access key deployment | `akia...` | | `aws_secret_access_key` | aws iam user secret key | `wjal...` | | `hmac_secret` | server-side hmac secret api request signing | (random secure string) | | `revalidate_secret` | secret on-demand cache revalidation api | (random secure string, 32+ chars) | | `sentry_dsn` | sentry dsn server-side error tracking | `https://...@sentry.io/...` | | `next_public_api_url` | production api backend url | `https://api-pre.esdeveniments.cat/api` | | `deepl_api_key` | deepl api key translation services | (deepl api authentication key) | ### optional secrets (recommended) | secret name | description | used | | ------------------------------------ | ------------------------------------------ | ------------------- | | `cloudflare_zone_id` | cloudflare zone id cache purging | cache invalidation | | `cloudflare_api_token` | cloudflare api token (zone.cache purge) | cache invalidation | | `sentry_auth_token` | sentry auth token source map uploads | better error traces | | `next_public_google_analytics` | google analytics measurement id | analytics | | `next_public_google_ads` | google ads conversion tracking id | ads tracking | | `next_public_google_maps` | google maps api key (client-side) | maps integration | | `next_public_google_site_verification` | google search console verification meta tag | seo verification | ### infrastructure secrets (optional) read `sst.config.ts` deploy time defaults: | secret name | description | default behavior | | -------------------- | ------------------------------------ | -------------------------------------------- | | `acm_certificate_arn` | ssl certificate arn | fetched ssm parameter store | | `alarm_email` | email cloudwatch alarm alerts | defaults `esdeveniments.catalunya.cat@gmail.com` | | `sentry_layer_arn` | sentry lambda layer arn | defaults eu-west-3 version 283 | ### aws ssm parameter store configuration stored aws systems manager parameter store: - **parameter:** `/esdeveniments-frontend/acm-certificate-arn` - **type:** string - **value:** arn acm certificate `*.esdeveniments.cat` **note:** parameter exist, `sst.config.ts` fall back `acm_certificate_arn` environment variable. --- ## key contacts / links - **aws console:** `eu-west-3` (paris) - **sst docs:** [sst.dev](https://sst.dev) - **cloudflare:** [dash.cloudflare.com](https://dash.cloudflare.com) - **github actions:** `.github/workflows/deploy-sst.yml`</file><file name="bundle-size-baseline.json">{ "version": 1, "lastupdated": "2025-12-25", "thresholds": { "warning": { "ratio": 0.05, "bytes": 51200 }, "error": { "ratio": 0.1, "bytes": 102400 } }, "clienttotalbytes": 2939061, "routes": { "/": { "serverbytes": 22950 }, "/[place]": { "serverbytes": 1310410 }, "/e/[eventid]": { "serverbytes": 1094728 }, "/noticies": { "serverbytes": 1389103 }, "/publica": { "serverbytes": 454637 } } }</file><file name="check-locales.mjs">import * cheerio "cheerio"; const default_locale = "ca"; const locales = ["ca", "es", "en"]; // configurable base url (supports localhost, staging, preview) const baseurl = process.env.base_url ?? "http://localhost:3000"; const paths = [ '/', '/catalunya', '/catalunya/avui', '/catalunya/avui/festes-populars', '/noticies', '/noticies/mataro/que-fer-el-cap-de-setmana-del-6-al-7-de-desembre-del-2025-a-mataro-d0a817fa-349d-4ef5-9f53-2eb042f446f6', '/e/festival-de-nadal-de-lescola-i-fira-de-nadal-18-de-desembre-del-2025-afa306c7-4812-44fe-bd8c-c716cd1eb5ce', '/publica', '/qui-som', '/sitemap', '/sitemap/mataro', '/offline' ]; function buildurl(path, locale) { const localizedpath = locale === default_locale ? path : `/${locale}${path}`; return new url(localizedpath, baseurl).tostring(); } function normalizeurl(value, base) { try { const u = new url(value, base); return `${u.origin}${u.pathname}${u.search}`; } catch { return value; } } function extractjsonldnodes(data) { (!data) return []; (array.isarray(data)) return data.flatmap(extractjsonldnodes); (typeof data !== "object") return []; const obj = data; const graph = array.isarray(obj["@graph"]) ? obj["@graph"] : null; (graph) return graph.flatmap(extractjsonldnodes); return [obj]; } function assertnodoublelocale(pathname, errors) { // guard /es/es/... en/en, ca/ca) (/\/(ca|es|en)\/\1(\/|$)/.test(pathname)) { errors.push(`double-locale-prefix url path: ${pathname}`); } } function assertlocaleprefix(pathname, locale, errors) { (locale === default_locale) { (/^\/(es|en)(\/|$)/.test(pathname) || /^\/ca(\/|$)/.test(pathname)) { errors.push(`default locale prefixed: ${pathname}`); } return; } (!(pathname === `/${locale}` || pathname.startswith(`/${locale}/`))) { errors.push(`expected /${locale} prefix path: ${pathname}`); } } async function check() { let totalerrors = 0; console.log(`base url: ${baseurl}`); (const path paths) { console.log(`\n=== path: ${path} ===`); (const locale locales) { const url = buildurl(path, locale); console.log(`\n--- url: ${url} (${locale}) ---`); const errors = []; try { const response = await fetch(url, { redirect: "follow" }); (!response.ok) { errors.push(`http ${response.status}`); } const html = await response.text(); const $ = cheerio.load(html); // --- html lang --- const htmllang = $("html").attr("lang") ?? ""; console.log(`html lang: ${htmllang || found"}`); (!htmllang) { errors.push("missing &lt;html lang&gt;"); } else (!htmllang.tolowercase().startswith(locale)) { errors.push(`html lang mismatch: expected ${locale}, got ${htmllang}`); } // --- canonical --- const canonicalhrefraw = $("link[rel=\"canonical\"]").attr("href") ?? ""; const canonicalhref = canonicalhrefraw ? normalizeurl(canonicalhrefraw, url) : ""; console.log(`canonical: ${canonicalhref || found"}`); (!canonicalhref) { errors.push("missing canonical link"); } else { try { const canonicalurl = new url(canonicalhref, url); assertnodoublelocale(canonicalurl.pathname, errors); assertlocaleprefix(canonicalurl.pathname, locale, errors); } catch { errors.push(`invalid canonical url: ${canonicalhref}`); } } // --- alternates --- const alternates = {}; $("link[rel=\"alternate\"][hreflang]").each((_, el) =&gt; { const hreflang = $(el).attr("hreflang") ?? ""; const href = $(el).attr("href") ?? ""; (!hreflang || !href) return; alternates[hreflang] = normalizeurl(href, url); }); const required = ["ca", "es", "en", "x-default"]; (const key required) { (!alternates[key]) { errors.push(`missing alternate hreflang=${key}`); } } // print alternates console.log("alternates:"); object.entries(alternates) .sort(([a], [b]) =&gt; a.localecompare(b)) .foreach(([k, v]) =&gt; console.log(` ${k}: ${v}`)); // validate alternates paths (const [hreflang, href] object.entries(alternates)) { try { const u = new url(href, url); assertnodoublelocale(u.pathname, errors); (hreflang === "x-default") { // must point default locale assertlocaleprefix(u.pathname, default_locale, errors); } (hreflang === "ca" || hreflang === "es" || hreflang === "en") { assertlocaleprefix(u.pathname, hreflang, errors); } } catch { errors.push(`invalid alternate url (${hreflang}): ${href}`); } } (alternates["ca"] &amp;&amp; alternates["x-default"]) { (alternates["x-default"] !== alternates["ca"]) { errors.push("x-default must match ca alternate"); } } // extract og locale const oglocale = $("meta[property=\"og:locale\"]").attr("content") ?? ""; console.log(`og locale: ${oglocale || found"}`); // --- json-ld --- const jsonldscripts = $("script[type=\"application/ld+json\"]") .toarray() .map((el) =&gt; $(el).text()); console.log(`json-ld tags found: ${jsonldscripts.length}`); let foundmatchinginlanguage = false; let foundeventwithcorrectlocale = false; (const content] jsonldscripts.entries()) { (!content || !content.trim()) continue; try { const parsed = json.parse(content); const nodes = extractjsonldnodes(parsed); const types = nodes .map((n) =&gt; n?.["@type"]) .flatmap((t) =&gt; (array.isarray(t) ? : .filter((t) =&gt; typeof === "string"); const nodeinlanguages = nodes .map((n) =&gt; n?.inlanguage) .filter((v) =&gt; typeof v === "string"); (nodeinlanguages.some((v) =&gt; v === locale)) { foundmatchinginlanguage = true; } // event detail pages, ensure least one event node localized (path.startswith("/e/")) { (const node nodes) { const = node?.["@type"]; const isevent = === "event" || (array.isarray(t) &amp;&amp; t.includes("event")); (!isevent) continue; (node?.inlanguage !== locale) continue; const href = node?.url || node?.["@id"]; (typeof href !== "string") continue; const u = new url(href, url); const localerrors = []; assertnodoublelocale(u.pathname, localerrors); assertlocaleprefix(u.pathname, locale, localerrors); (localerrors.length === 0) { foundeventwithcorrectlocale = true; break; } } } const typesummary = types.length ? array.from(new set(types)).join(",") : "unknown"; const inlangsummary = nodeinlanguages.length ? array.from(new set(nodeinlanguages)).join(",") : "none"; console.log(` json-ld + 1}: @type=${typesummary} inlanguage=${inlangsummary}`); } catch { errors.push(`invalid json-ld (script + 1})`); } } // require least one localized inlanguage value (regression guard) (jsonldscripts.length &gt; 0 &amp;&amp; !foundmatchinginlanguage) { errors.push(`no json-ld node inlanguage=${locale}`); } (path.startswith("/e/") &amp;&amp; !foundeventwithcorrectlocale) { errors.push("no localized event json-ld found"); } } catch (err) { errors.push(`fetch error: ${err.message}`); } (errors.length &gt; 0) { totalerrors += errors.length; console.log("result: fail"); errors.foreach((e) =&gt; console.log(` - ${e}`)); } else { console.log("result: pass"); } } } (totalerrors &gt; 0) { console.error(`\nlocalization check failed ${totalerrors} error(s).`); process.exitcode = 1; } else { console.log("\nlocalization check passed."); } } check();</file><file name="customHttp.yml"># custom http headers configuration aws amplify # file replaces deprecated customheaders section amplify.yml # see: https://docs.aws.amazon.com/amplify/latest/userguide/custom-headers.html customheaders: # service worker: avoid caching allow root scope - pattern: "/sw.js" headers: - key: cache-control value: "no-cache, no-store, must-revalidate" - key: service-worker-allowed value: "/" # next.js built assets - automatically hashed, safe long cache - pattern: "/_next/static/**" headers: - key: cache-control value: "public, max-age=31536000, immutable" # next.js optimized images - 1 year cache (critical performance) - pattern: "/_next/image*" headers: - key: cache-control value: "public, max-age=31536000, immutable" # css files - safe long cache; cache-busting handled deployment - pattern: "/styles/**" headers: - key: cache-control value: "public, max-age=31536000, immutable" - key: content-type value: "text/css; charset=utf-8" # font files - longer cache cors headers cross-origin loading - pattern: "/static/fonts/**" headers: - key: cache-control value: "public, max-age=31536000, immutable" - key: access-control-allow-origin value: "*" - key: cross-origin-resource-policy value: "cross-origin" # static assets - conservative since may use getversionedurl - pattern: "/static/**" headers: - key: cache-control value: "public, max-age=2592000" # 30 days # static images user uploads) - conservative approach # separate patterns common image extensions (brace expansion supported) - pattern: "/static/**/*.png" headers: - key: cache-control value: "public, max-age=2592000" # 30 days - pattern: "/static/**/*.jpg" headers: - key: cache-control value: "public, max-age=2592000" # 30 days - pattern: "/static/**/*.jpeg" headers: - key: cache-control value: "public, max-age=2592000" # 30 days - pattern: "/static/**/*.gif" headers: - key: cache-control value: "public, max-age=2592000" # 30 days - pattern: "/static/**/*.webp" headers: - key: cache-control value: "public, max-age=2592000" # 30 days - pattern: "/static/**/*.svg" headers: - key: cache-control value: "public, max-age=2592000" # 30 days - pattern: "/static/**/*.ico" headers: - key: cache-control value: "public, max-age=2592000" # 30 days # fonts - longer cache since rarely change (avoid brace expansion) - pattern: "/**/*.woff" headers: - key: cache-control value: "public, max-age=31536000" # 1 year - pattern: "/**/*.woff2" headers: - key: cache-control value: "public, max-age=31536000" # 1 year - pattern: "/**/*.ttf" headers: - key: cache-control value: "public, max-age=31536000" # 1 year - pattern: "/**/*.eot" headers: - key: cache-control value: "public, max-age=31536000" # 1 year # next.js pages - enable back/forward cache better performance # pattern matches html pages routes without file extensions - pattern: "/*" headers: - key: cache-control value: "public, max-age=0, s-maxage=3600, stale-while-revalidate=86400" # api routes - cors headers functionality (middleware excludes - pattern: "/api/**" headers: - key: access-control-allow-origin value: "https://esdeveniments.cat" - key: access-control-allow-methods value: "get,options,patch,delete,post,put" - key: access-control-allow-headers value: "x-csrf-token, x-requested-with, accept, accept-version, content-length, content-md5, content-type, date, x-api-version" - key: vary value: "origin" - key: cache-control value: "public, max-age=3600" # 1 hour - conservative api responses</file><file name="eslint.config.mjs">import next "eslint-config-next"; import nextcorewebvitals "eslint-config-next/core-web-vitals"; import globals "globals"; import path "node:path"; import { fileurltopath } "node:url"; import js "@eslint/js"; import { flatcompat } "@eslint/eslintrc"; import reacthooks "eslint-plugin-react-hooks"; import eslintreact "@eslint-react/eslint-plugin"; const __filename = fileurltopath(import.meta.url); const __dirname = path.dirname(__filename); const compat = new flatcompat({ basedirectory: __dirname, recommendedconfig: js.configs.recommended, allconfig: js.configs.all, }); export default [ { ignores: [ ".sst/**", ".sst/**/*", ".sst", ".sst.*", "*.sst", "**/.sst/**", ".open-next/**", ".open-next/**/*", ".next/**", ".next/**/*", "sst-env.d.ts", ], }, // spread converted eslintrc configs flatcompat ...compat.extends("eslint:recommended"), // spread next.js configs already flat config compatible) ...next, ...nextcorewebvitals, // base configuration { languageoptions: { globals: { ...globals.browser, ...globals.node, ...globals.jest, }, }, plugins: { "react-hooks": reacthooks, }, rules: { "no-undef": "error", "no-debugger": "error", "react/react-in-jsx-scope": "react-hooks/rules-of-hooks": "error", "react-hooks/exhaustive-deps": "warn", "react-hooks/set-state-in-effect": "error", }, }, { files: ["public/sw.js", "public/sw-template.js"], languageoptions: { globals: { ...globals.serviceworker, workbox: "readonly", importscripts: "readonly", caches: "readonly", self: "readonly", }, }, rules: { "no-undef": }, }, { files: ["**/*.ts", "**/*.tsx"], rules: { "no-undef": "no-unused-vars": // typescript handles "@typescript-eslint/no-unused-vars": [ "warn", { argsignorepattern: "^_", varsignorepattern: "^_" }, ], }, }, { files: [ "components/**/*.{ts,tsx,js,jsx}", "app/**/*.{ts,tsx,js,jsx}", "**/store.ts", "utils/**/*.{ts,tsx,js,jsx}", "lib/**/*.{ts,tsx,js,jsx}", ], ignores: ["types/**/*.ts"], rules: { "no-restricted-syntax": [ "error", { selector: "tstypealiasdeclaration", message: declare types outside /types directory. centralize type aliases /types.", }, { selector: "tsinterfacedeclaration", message: declare interfaces outside /types directory. centralize interfaces /types.", }, ], }, }, { files: ["types/**/*.ts"], ignores: ["types/common.ts", "types/api/city.ts"], rules: { "@typescript-eslint/no-unused-vars": "error", "no-restricted-syntax": [ "error", { selector: "tsinterfacedeclaration[id.name='navigationitem']", message: "navigationitem interface already defined. use canonical version types/common.ts.", }, { selector: "tsinterfacedeclaration[id.name='sociallinks']", message: "sociallinks interface already defined. use canonical version types/common.ts.", }, { selector: "tsinterfacedeclaration[id.name='eventprops']", message: "eventprops interface already defined. use canonical version types/common.ts.", }, { selector: "tsinterfacedeclaration[id.name='citysummaryresponsedto']", message: "citysummaryresponsedto interface already defined. use canonical version types/api/city.ts.", }, ], }, }, // disable anonymous default export warning config file { files: ["eslint.config.mjs"], rules: { "import/no-anonymous-default-export": }, }, // @eslint-react: comprehensive react best practices performance rules { files: ["**/*.tsx", "**/*.jsx"], ...eslintreact.configs.recommended, rules: { ...eslintreact.configs.recommended.rules, // relax rules may strict fit next.js patterns "@eslint-react/prefer-destructuring-assignment": // common next.js hydration pattern (setismounted, setishydrated, etc.) "@eslint-react/hooks-extra/no-direct-set-state-in-use-effect": // react 19 migration - address gradually "@eslint-react/no-context-provider": "@eslint-react/no-use-context": "@eslint-react/no-forward-ref": }, }, // disable hook naming rules test mocks need match real hook names) { files: ["test/**/*.tsx", "test/**/*.ts"], rules: { "@eslint-react/no-unnecessary-use-prefix": }, }, // warn raw fetch() usage - prefer fetchwithhmac safefetch // raw fetch lacks timeout, response validation, error handling // warning flag new code review - many existing uses legitimate // (internal api routes, swr fetchers, api route handlers) { files: [ "app/**/*.ts", "app/**/*.tsx", "lib/**/*.ts", "components/**/*.ts", "components/**/*.tsx", ], ignores: [ "lib/api/fetch-wrapper.ts", // wrapper "utils/safe-fetch.ts", // safe-fetch utility "test/**/*", // tests mock fetch "app/api/**/*", // api routes endpoints "lib/api/*.ts", // internal api client calls (same-origin, next.js handles) "components/hooks/use*.ts", // swr fetchers (same-origin) ], rules: { "no-restricted-globals": [ "warn", { name: "fetch", message: "review: prefer fetchwithhmac (internal api) safefetch (external webhooks) timeout &amp; error handling. ignore calling same-origin internal routes.", }, ], }, }, // critical: prevent searchparams listing pages avoid $300+ dynamodb cost spikes // reading searchparams makes pages dynamic, causing opennext/sst create millions cache entries // see: dec 28, 2025 incident - 200m dynamodb writes = $307 cost { files: ["app/\\[place\\]/**/*.tsx", "app/\\[place\\]/**/*.ts"], rules: { "no-restricted-syntax": [ "error", { selector: "identifier[name='searchparams']", message: " cost alert: use searchparams app/[place]/* pages! makes pages dynamic causes opennext create millions dynamodb cache entries ($300+ cost spike dec 28, 2025). handle query params middleware (proxy.ts) client-side (swr) instead.", }, ], }, }, ];</file><file name="instrumentation-client.ts">// client instrumentation hook next.js app router. // sentry initialization handled `sentry.client.config.ts`. import { captureroutertransitionstart } "@sentry/nextjs"; export const onroutertransitionstart = captureroutertransitionstart;</file><file name="instrumentation.ts">import * sentry '@sentry/nextjs'; export async function register() { (process.env.next_runtime === 'nodejs') { await import('./sentry.server.config'); } (process.env.next_runtime === 'edge') { await import('./sentry.edge.config'); } } export const onrequesterror = sentry.capturerequesterror;</file><file name="jsconfig.json">{ "compileroptions": { "paths": { "@store": ["./store.js"], "@app/*": ["./app/*"], "@components/*": ["./components/*"], "@styles/*": ["./styles/*"], "@content/*": ["./content/*"], "@utils/*": ["./utils/*"], "@lib/*": ["./lib/*"], "@config/*": ["./config/*"], "@public/*": ["./public/*"], "@types/*": ["./types/*"] }, "types": ["./types/react-datepicker.d.ts", "./types/navigator.d.ts"] } }</file><file name="next-intl.config.ts">import { default_locale, locale_prefix_strategy, supported_locales, } "./types/i18n"; const config = { locales: supported_locales, defaultlocale: default_locale, localeprefix: locale_prefix_strategy, }; export default config;</file><file name="next-sitemap.d.ts">declare module 'next-sitemap' { export const getserversidesitemaplegacy: export type isitemapfield = }</file><file name="next.config.js">const { withsentryconfig } = require("@sentry/nextjs"); const createnextintlplugin = require("next-intl/plugin"); const withbundleanalyzer = require("@next/bundle-analyzer")({ enabled: process.env.analyze === "true" || process.env.bundle_analyze === "browser" || process.env.bundle_analyze === "server", }); const withnextintl = createnextintlplugin(); /** @type {import('next').nextconfig} */ const nextconfig = { // --- core settings --- reactstrictmode: true, poweredbyheader: false, compress: true, productionbrowsersourcemaps: false, // --- sst/opennext configuration --- // required sst deployment (uses opennext adapter) output: "standalone", // mark sharp native dependencies external - required sst/lambda deployment // sharp native binaries must bundled separately target platform // include @img/* packages ensure turbopack mangle module resolution serverexternalpackages: [ "sharp", "@img/sharp-linux-x64", "@img/sharp-libvips-linux-x64", ], // disable incremental cache sst/opennext lacks __fetch bucket cachehandler: undefined, cachemaxmemorysize: 0, // --- react compiler (next 16: moved top-level) --- reactcompiler: true, cachecomponents: false, // --- experimental features --- experimental: { scrollrestoration: true, inlinecss: true, // tree-shake heavy libraries reduce lambda bundle size optimizepackageimports: [ "@headlessui/react", "@heroicons/react", "date-fns", "react-datepicker", "react-select", "react-share", "react-tooltip", ], // --- server actions configuration --- serveractions: { // 10mb support image uploads event creation (see app/publica/page.tsx) bodysizelimit: "10mb", }, }, // --- optimizations --- compiler: { removeconsole: process.env.node_env === "production", }, // --- image optimization --- images: { // important: whitelist specific domains load images // using wildcards security risk. remotepatterns: [ { protocol: "https", hostname: "**" }, { protocol: "http", hostname: "**" }, ], devicesizes: [480, 640, 768, 1024, 1280, 1600, 1920], imagesizes: [16, 32, 48, 64, 96, 128, 256, 384], formats: ["image/avif", "image/webp"], // aggressive caching cloudfront: 1 year (31536000 seconds) // prevents lambda image optimizer invoked repeatedly image. // cache-busting handled explicitly utils/image-cache.ts using event.hash/updatedat, // updating image changes url (e.g., ?v=&lt;hash&gt;) forces cloudfront fetch minimumcachettl: 31536000, // next.js 16: explicitly configure allowed quality values // reduced 10 5 values minimize cache fragmentation lambda invocations qualities: [35, 50, 60, 75, 85], // next.js 16: configure local patterns api routes query strings // allow query string internal image proxy route localpatterns: [ { pathname: "/api/places/photo", }, { pathname: "/api/image-proxy", }, // allow loading local images public/static directory (e.g., /static/images/*) { pathname: "/static/**", }, ], }, // `headers` block removed. // security caching headers managed dynamically `proxy.ts` (next.js 16: renamed middleware.ts). // csp uses relaxed policy host allowlisting enable isr/ppr caching. // --- redirects --- async redirects() { return []; }, }; // enable uploads auth token present. otherwise skip network calls avoid build failures. const sentryuploadsenabled = boolean(process.env.sentry_auth_token); module.exports = withsentryconfig( withbundleanalyzer(withnextintl(nextconfig)), { // available options, see: // https://www.npmjs.com/package/@sentry/webpack-plugin#options org: "esdeveniments-fw", project: "javascript-nextjs", // print logs uploading source maps ci silent: !process.env.ci, // skip sentry network operations auth token configured (e.g., ci builds) dryrun: !sentryuploadsenabled, // available options, see: // https://docs.sentry.io/platforms/javascript/guides/nextjs/manual-setup/ // upload larger set source maps prettier stack traces (increases build time) widenclientfileupload: true, // transpile client sdk better compatibility transpileclientsdk: true, // prevent original sources appearing devtools production hidesourcemaps: true, // exclude patterns source map uploads reduce upload time size // excludes node_modules, .next build artifacts, non-source files sourcemaps: { ignore: [ "node_modules/**", ".next/**", ".sentry/**", "**/*.test.{js,ts,tsx}", "**/*.spec.{js,ts,tsx}", "**/test/**", "**/tests/**", "**/__tests__/**", "**/e2e/**", "**/*.config.{js,ts}", "**/scripts/**", ], // upload source maps javascript/typescript files // provides better stack traces increases upload time assets: "**/*.{js,jsx,ts,tsx}", // delete source maps upload prevent exposing production deletesourcemapsafterupload: true, }, // route browser requests sentry next.js rewrite circumvent ad-blockers. // increase server load well hosting bill. // note: check configured route match next.js middleware, otherwise reporting client- // side errors fail. tunnelroute: "/monitoring", // sentry configuration options (next.js 16 / sentry v10+) webpack: { treeshake: { // remove sdk debug logging code removedebuglogging: true, // remove tracing code since tracessamplerate 0 removetracing: true, // remove iframe capture code session replay excludereplayiframe: true, // remove shadow dom capture code session replay excludereplayshadowdom: true, }, automaticvercelmonitors: true, }, // release tracking: associate source maps specific release // falls back git commit sha available, otherwise uses timestamp release: { name: process.env.sentry_release || process.env.vercel_git_commit_sha || `esdeveniments@${date.now()}`, // automatically create release exist create: true, // automatically finalize release build completes finalize: true, // set commits better release tracking (requires sentry_auth_token) setcommits: sentryuploadsenabled ? { auto: true, } : undefined, }, // error handling: log errors source map upload fail build errorhandler: (err) =&gt; { // log errors ci, silently fail otherwise avoid build noise (process.env.ci) { console.warn("sentry source map upload warning:", err.message); } // throw - allow build continue even source map upload fails }, } );</file><file name="open-next.config.ts">/** * opennext configuration sst deployment. * * config ensures sharp native binaries installed server function * custom /api/image-proxy route needs image processing capabilities. * * note: opennext excludes sharp server bundle default * included image-optimization function /_next/image). since * custom image proxy, need explicitly install */ const config = { default: { install: { // install sharp correct architecture lambda packages: ["sharp@0.34.5"], // match architecture sst.config.ts (x86_64) arch: "x64", }, }, }; export default config;</file><file name="package.json">{ "private": true, "engines": { "node": "22.x", "yarn": "&gt;=4.0.0" }, "scripts": { "analyze": "cross-env analyze=true next build", "analyze:browser": "cross-env bundle_analyze=browser next build", "analyze:server": "cross-env bundle_analyze=server next build", "analyze:experimental": "next experimental-analyze", "analyze:webpack": "cross-env analyze=true next build --webpack", "analyze:cli": "node scripts/analyze-bundles-cli.mjs", "analyze:api": "node scripts/analyze-bundles-api.mjs", "upgrade": "next upgrade", "build": "next build", "build:development": "node_env=development env-cmd -f .env.development yarn run prebuild &amp;&amp; env-cmd -f .env.development next build", "build:production": "node_env=production env-cmd -f .env.production yarn run prebuild &amp;&amp; env-cmd -f .env.production next build", "build:staging": "node_env=staging env-cmd -f .env.staging yarn run prebuild &amp;&amp; env-cmd -f .env.staging next build", "dev": "next dev", "dev:inspect": "next dev --inspect", "lint": "eslint .", "prebuild": "node scripts/generate-sw.mjs &amp;&amp; node scripts/generate-robots.mjs", "prepare": "husky", "scan": "npx react-scan@latest localhost:3000", "i18n:sync": "node scripts/sync-locales.mjs", "i18n:check": "i18n-check ca --locales messages invalidkeys,missingkeys \"utils.calendar.moreinfohtml\" \"utils.stringhelpers.capitalizeprepositions.*\" \"utils.stringhelpers.feminineexceptions.*\" \"utils.stringhelpers.masculineexceptions.*\"", "i18n:validate": "node scripts/validate-i18n-placeholders.mjs", "lighthouse:ci": "lhci autorun --config=.lighthouserc.json", "start": "next start", "start:development": "env-cmd -f .env.development next start", "start:production": "node_env=production env-cmd -f .env.production next start", "start:staging": "env-cmd -f .env.staging next start", "test": "vitest run", "test:coverage": "vitest run --coverage", "test:e2e": "playwright test", "test:e2e:debug": "playwright test --debug", "test:e2e:ui": "playwright test --ui", "test:watch": "vitest", "typecheck": "tsc --noemit", "typecheck:sst": "tsc --noemit --project tsconfig.sst.json" }, "lint-staged": { "*.{js,jsx,ts,tsx}": [ "eslint --fix" ], "messages/*.json": [ "yarn i18n:check", "yarn i18n:validate" ] }, "dependencies": { "@headlessui/react": "^2.2.9", "@heroicons/react": "^2.2.0", "@img/sharp-libvips-linux-x64": "^1.2.4", "@img/sharp-linux-x64": "^0.34.5", "@sentry/nextjs": "10.32.0", "@tailwindcss/aspect-ratio": "^0.4.2", "@tailwindcss/forms": "^0.5.3", "@tailwindcss/typography": "^0.5.9", "autoprefixer": "^10.4.20", "cssnano": "^7.0.6", "date-fns": "^4.1.0", "fast-xml-parser": "^4.4.0", "feed": "^5.1.0", "next": "16.1.1", "next-intl": "^4.6.1", "postcss": "^8.5.1", "react": "19.2.3", "react-datepicker": "^8.8.0", "react-dom": "19.2.3", "react-select": "^5.7.0", "react-share": "^5.0.3", "react-tooltip": "^5.26.0", "sharp": "^0.34.5", "sst": "^3.17.25", "swr": "^2.2.5", "tailwindcss": "3.3.6", "zod": "3.24.3", "zustand": "^5.0.8" }, "devdependencies": { "@aws-sdk/client-ssm": "^3.940.0", "@eslint-react/eslint-plugin": "^2.5.3", "@lhci/cli": "^0.15.1", "@lingual/i18n-check": "^0.8.15", "@next/bundle-analyzer": "^16.1.0", "@opentelemetry/api": "^1.9.0", "@opentelemetry/context-async-hooks": "^2.2.0", "@opentelemetry/core": "^2.2.0", "@opentelemetry/sdk-trace-base": "^2.2.0", "@playwright/test": "1.56.0", "@testing-library/dom": "^10.4.1", "@testing-library/jest-dom": "^6.9.1", "@testing-library/react": "^16.3.0", "@types/jest": "^30.0.0", "@types/jsdom": "^21.1.7", "@types/node": "^24.10.1", "@types/react": "^19.2.7", "@types/react-datepicker": "^7.0.0", "@types/react-dom": "^19.2.3", "@typescript-eslint/eslint-plugin": "^8.48.0", "@typescript-eslint/parser": "^8.48.0", "@vitejs/plugin-react": "^4.3.0", "babel-plugin-react-compiler": "^19.1.0-rc.1", "baseline-browser-mapping": "^2.8.32", "cheerio": "^1.1.2", "cross-env": "^10.1.0", "env-cmd": "^10.1.0", "eslint": "9", "eslint-config-next": "^16.1.0", "eslint-plugin-react-hooks": "^7.0.1", "husky": "^9.1.7", "jsdom": "^26.1.0", "lint-staged": "^16.2.7", "next-sitemap": "^4.2.3", "typescript": "5.9.3", "vite": "7.2.4", "vite-tsconfig-paths": "^4.3.0", "vitest": "4.0.14" }, "packagemanager": "yarn@4.12.0", "browserslist": { "development": [ "last 1 chrome version", "last 1 firefox version", "last 1 safari version" ], "production": [ "chrome &gt;= 119", "edge &gt;= 119", "firefox &gt;= 121", "safari &gt;= 17", "ios_saf &gt;= 17" ] }, "resolutions": { "@types/react": "^19.2.7", "@types/react-dom": "^19.2.3" } }</file><file name="playwright.config.ts">import { defineconfig, devices } "@playwright/test"; const host = process.env.host || "127.0.0.1"; const port = process.env.port || "3000"; const baseurl = process.env.playwright_test_base_url || `http://${host}:${port}`; const vercelbypasssecret = process.env.vercel_automation_bypass_secret; const vercelbypassheaders: record&lt;string, string&gt; = vercelbypasssecret ? { "x-vercel-protection-bypass": vercelbypasssecret, "x-vercel-set-bypass-cookie": "true", } : {}; // ensure spawned dev server inherits required env ci without violating ts types const webserverenv: record&lt;string, string&gt; = { node_env: process.env.node_env || "development", e2e_test_mode: "1", next_public_e2e_test_mode: "1", host: host, port: port, }; (process.env.next_public_api_url) { webserverenv.next_public_api_url = process.env.next_public_api_url; } (process.env.hmac_secret) { webserverenv.hmac_secret = process.env.hmac_secret; } export default defineconfig({ testdir: "./e2e", fullyparallel: true, forbidonly: !!process.env.ci, retries: process.env.ci ? 1 : 0, // reduced 1 retry avoid exceeding ci timeout workers: process.env.ci ? 2 : undefined, // use 2 workers ci faster execution (conservative remote urls) maxfailures: process.env.ci ? 10 : undefined, // fail fast ci many tests fail timeout: process.env.ci ? 120000 : 60000, // global test timeout: 120s ci (remote urls), 60s locally reporter: process.env.ci ? [["blob"], ["html", { open: "never", outputfolder: "playwright-report" }]] : [["list"], ["html", { open: "never" }]], use: { baseurl: baseurl, navigationtimeout: process.env.ci ? 120000 : 90000, // higher timeout ci remote urls trace: "on-first-retry", screenshot: "only-on-failure", video: "retain-on-failure", locale: "ca-es", extrahttpheaders: { "accept-language": "ca", ...vercelbypassheaders, }, }, projects: [ { name: "chromium", use: { ...devices["desktop chrome"], // block service workers allow playwright route handlers intercept requests // sws intercept fetch playwright's network layer, breaking route mocks serviceworkers: "block", }, }, ], webserver: { command: "e2e_test_mode=1 yarn dev", url: baseurl, reuseexistingserver: true, timeout: 120000, // ensure spawned dev server inherits required env ci env: webserverenv, }, expect: { timeout: process.env.ci ? 20000 : 10000 }, // provide env app server (next.js) via process.env ci start step. // github actions set next_public_api_url; also export e2e_test_mode enable deterministic publish flow. });</file><file name="playwright.remote.config.ts">import { defineconfig, devices } "@playwright/test"; // remote config run existing deployed url (e.g., amplify preview) // important: start local webserver const baseurl = process.env.playwright_test_base_url || "http://localhost:3000"; const vercelbypasssecret = process.env.vercel_automation_bypass_secret; const vercelbypassheaders: record&lt;string, string&gt; = vercelbypasssecret ? { "x-vercel-protection-bypass": vercelbypasssecret, "x-vercel-set-bypass-cookie": "true", } : {}; export default defineconfig({ testdir: "./e2e", fullyparallel: true, forbidonly: !!process.env.ci, retries: process.env.ci ? 2 : 0, workers: process.env.ci ? 1 : undefined, reporter: process.env.ci ? [ ["blob"], ["html", { open: "never", outputfolder: "playwright-report" }], ] : [["list"], ["html", { open: "never" }]], use: { baseurl, navigationtimeout: 45000, trace: "on-first-retry", screenshot: "only-on-failure", video: "retain-on-failure", locale: "ca-es", extrahttpheaders: { "accept-language": "ca", ...vercelbypassheaders, }, }, projects: [ { name: "chromium", use: { ...devices["desktop chrome"], // block service workers allow playwright route handlers intercept requests. // sws intercept fetch playwright's network layer, breaking route mocks. serviceworkers: "block", }, }, ], expect: { timeout: 10000 }, });</file><file name="postcss.config.js">module.exports = { plugins: { tailwindcss: {}, autoprefixer: {}, cssnano: { preset: "default" }, }, };</file><file name="project-snapshot.txt">&lt;?xml version='1.0' encoding='utf-8'?&gt; &lt;source type="github_repository"&gt;&lt;commit&gt;unknown&lt;/commit&gt;&lt;file name=".eslintrc.json"&gt;{ "plugins": ["@typescript-eslint"], "extends": [ "eslint:recommended", "next", "next/core-web-vitals", "plugin:@typescript-eslint/recommended" ], "rules": { "no-unused-vars": "warn", "no-undef": "error", "no-debugger": "error", "react/react-in-jsx-scope": }, "env": { "es6": true, "browser": true, "node": true, "jest": true }, "overrides": [ { "files": ["public/sw.js", "public/sw-template.js"], "env": { "serviceworker": true }, "globals": { "workbox": "readonly", "importscripts": "readonly", "caches": "readonly", "self": "readonly" }, "rules": { "no-undef": } }, { "files": ["*.ts", "*.tsx"], "rules": { "no-undef": } }, { "files": [ "components/**/*.{ts,tsx,js,jsx}", "app/**/*.{ts,tsx,js,jsx}", "store.ts", "utils/**/*.{ts,tsx,js,jsx}" ], "rules": { "no-restricted-syntax": [ "error", { "selector": "tstypealiasdeclaration", "message": declare types outside /types directory. centralize type aliases /types." }, { "selector": "tsinterfacedeclaration", "message": declare interfaces outside /types directory. centralize interfaces /types." } ] } }, { "files": ["types/**/*.ts"], "rules": { "@typescript-eslint/no-unused-vars": "error", "no-restricted-syntax": [ "error", { "selector": "tsinterfacedeclaration[declaration.name='navigationitem']:not(:first-of-type)", "message": "navigationitem interface already defined. use canonical version types/common.ts." }, { "selector": "tsinterfacedeclaration[declaration.name='sociallinks']:not(:first-of-type)", "message": "sociallinks interface already defined. use canonical version types/common.ts." }, { "selector": "tsinterfacedeclaration[declaration.name='eventprops']:not(:first-of-type)", "message": "eventprops interface already defined. use canonical version types/common.ts." }, { "selector": "tsinterfacedeclaration[declaration.name='citysummaryresponsedto']:not(:first-of-type)", "message": "citysummaryresponsedto interface already defined. use canonical version types/api/city.ts." } ] } } ] }&lt;/file&gt;&lt;file name=".yarnrc.yml"&gt;nodelinker: node-modules yarnpath: .yarn/releases/yarn-4.9.1.cjs&lt;/file&gt;&lt;file name="agents.md"&gt;# repository guidelines ## project structure &amp;amp; module organization - `app/` next.js app router (layouts, routes, api `app/api`). example: `app/[place]/page.tsx`. - `components/` reusable ui (`ui/`, `partials/`, `hooks/`). prefer feature folders `components/ui/...`. - `lib/`, `utils/` shared logic; `config/` app config; `types/` canonical typescript types. - `public/` static assets; `styles/` tailwind; `docs/` notes; `scripts/` build utilities (e.g., `generate-sw.mjs`). - `test/` unit/integration (vitest); `e2e/` playwright. - path aliases `tsconfig.json` (e.g., `@components/*`, `@utils/*`). ## build, test, development commands - `yarn dev` start local dev (runs prebuild: service worker generation). - `yarn build` production build; `postbuild` runs `next-sitemap`. - `yarn start` serve built app; `yarn lint` eslint; `yarn typecheck` ts noemit. - `yarn test` vitest; `yarn test:watch`; `yarn test:coverage`. - `yarn test:e2e` playwright; `yarn test:e2e:ui` ui runner. remote: `playwright.remote.config.ts` `playwright_test_base_url`. - extras: `yarn analyze` bundle analysis; `yarn scan` run reactscan `localhost:3000`. - ci: amplify builds use node 20 + yarn 4; prebuild generates `public/sw.js` postbuild runs sitemap. ## coding style &amp;amp; naming conventions - typescript strict; prefer server components default. add `"use client"` needed. - eslint extends `next/core-web-vitals` + ts. fix warnings merge. - define type aliases/interfaces `types/` (eslintenforced). - components: pascalcase; hooks: `usexxx`; helpers: lowercamelcase. - indentation: 2 spaces; prefer path aliases; tailwind utilities styling; globals `styles/`. ## testing guidelines - unit tests: vitest + jsdom; react testing library. files: `test/**/*.{test,spec}.{ts,tsx}`. - aim meaningful coverage new code (`yarn test:coverage`). - e2e: playwright `e2e/`. local config starts app; remote config targets existing url via `playwright_test_base_url`. - test bootstrap: `test/setup.ts` seeds `hmac_secret` hmac utilities. ## commit &amp;amp; pull request guidelines - conventional commits: `feat:`, `fix:`, `chore:`, `docs:`, `test:`, `refactor:`. use scope helpful (e.g., `feat(ui): sharebutton`). - keep messages imperative specific; avoid `wip` mainline branches. - prs include: summary, linked issues, screenshots ui, test plan. - run `yarn lint &amp;amp;&amp;amp; yarn typecheck &amp;amp;&amp;amp; yarn test` e2e relevant) pushing. - branching: use shortlived `feat/*` `fix/*` branches; target default branch `develop` active). ## security &amp;amp; configuration tips - never commit secrets. use `.env.development`, `.env.staging`, `.env.production` (loaded via `env-cmd`). - `next_public_api_url` influences service worker (generated `public/sw-template.js`) tests. changes, rerun prebuild/dev. - sentry configured (`sentry.*.config.ts`); set dsn nonlocal environments. - yarn 4 workspace; prefer `yarn` `npm`. - csp nonce: middleware injects `x-nonce`; pass `&amp;lt;script nonce={...}&amp;gt;` (see `app/layout.tsx:28`, `app/googlescripts.tsx:7`). ## agent-specific instructions - prefer surgical diffs; keep file moves/renames minimal scoped. - edit generated build output (`public/sw.js`, `.next/**`, `tsconfig.tsbuildinfo`, `server-place-sitemap.xml`). edit `public/sw-template.js` run prebuild instead. - types live `types/`; avoid redefining `navigationitem`, `sociallinks`, `eventprops`, `citysummaryresponsedto` (see `types/common.ts`, `types/api/city.ts`). - server-first default; mark client components `"use client"` necessary. avoid exposing secrets client code. - api security: middleware enforces hmac `/api/*`. browser-callable endpoints, prefer server proxy narrow allowlist entry; never sign requests browser. - use yarn 4 commands node 20 locally; run `yarn lint &amp;amp;&amp;amp; yarn typecheck &amp;amp;&amp;amp; yarn test` finalizing changes. ## architecture overview - next.js app router serverfirst rendering; client state via zustand (`store.ts`) client data fetching via swr. - seo &amp;amp; sitemaps: `next-sitemap` runs build; sitemap routes `app/`; `middleware.ts` handles edge behavior. ## local setup - requirements: node 20, yarn 4.9+ (use corepack). - install: `corepack enable &amp;amp;&amp;amp; corepack prepare yarn@4.9.1 --activate &amp;amp;&amp;amp; yarn install --immutable`. - env: set `hmac_secret` (serveronly), `next_public_api_url` (defaults handled), optional `next_public_google_analytics`, `next_public_google_ads`, `sentry_dsn`. - run: `yarn dev` (generates `public/sw.js` via prebuild). build: `yarn build`. - tests: `yarn test`; e2e: `yarn test:e2e` (local config starts app). ## feature checklist - types: add/extend `types/` inline app/component types). - ui/pages: place components `components/ui/&amp;lt;feature&amp;gt;/`; routes `app/&amp;lt;segment&amp;gt;/` (serverfirst; add `"use client"` needed). - api: call server code via internal api; respect hmac middleware. public endpoints, use extend allowlist carefully. - tests: add unit tests `test/` e2e flows `e2e/` uservisible. - sw/caching: adding external api usage offline behavior, edit `public/sw-template.js` rerun prebuild/dev. - prepr: `yarn lint &amp;amp;&amp;amp; yarn typecheck &amp;amp;&amp;amp; yarn test` e2e applicable); include screenshots ui.&lt;/file&gt;&lt;file name="readme.md"&gt;# que fer next.js app productionready next.js 15 + typescript app using app router. includes tailwindcss, swr, zustand, vitest, playwright, sentry, workboxbased service worker. contribution rules, see agents.md. ## quickstart 1) requirements: node 20 yarn 4 (corepack) ```bash corepack enable &amp;amp;&amp;amp; corepack prepare yarn@4.9.1 --activate yarn install --immutable ``` 2) environment create `.env.development` set ci/hosting others): - hmac_secret=your-server-secret - next_public_api_url=https://api-pre.esdeveniments.cat prod) - optional: next_public_google_analytics, next_public_google_ads, sentry_dsn 3) run ```bash yarn dev # build: generates sw, builds app, sitemaps yarn build &amp;amp;&amp;amp; yarn start ``` ## scripts - dev: start next.js (prebuild generates `public/sw.js` `public/sw-template.js`) - build/start: production build serve; postbuild runs `next-sitemap` - lint/typecheck: eslint `tsc --noemit` - test/test:watch/test:coverage: vitest (jsdom, rtl) - test:e2e, test:e2e:ui, test:e2e:debug: playwright - analyze, scan: bundle analysis react-scan localhost ## structure - app/ (routes, layouts, api app/api) - components/ (ui/, partials/, hooks/) - lib/, utils/, config/, types/ - styles/, public/, scripts/ (e.g., `generate-sw.mjs`), docs/ - test/ (vitest), e2e/ (playwright) - path aliases tsconfig: `@components/*`, `@utils/*`, etc. ## testing - unit/integration: `yarn test`; coverage: `yarn test:coverage` - e2e local: `yarn test:e2e` (starts dev server) - e2e remote: use `playwright.remote.config.ts` `playwright_test_base_url` ## security &amp;amp; api - middleware enforces hmac `/api/*` routes (`x-hmac`, `x-timestamp`); avoid signing browser. use server routes allowlisted endpoints. - csp nonce injected middleware; pass `&amp;lt;script nonce&amp;gt;` (see `app/layout.tsx`, `app/googlescripts.tsx`). ## deploy - aws amplify config (`amplify.yml`) uses node 20 + yarn 4, immutable installs, prebuild sw generation, next sitemap postbuild. set environment variables hosting.&lt;/file&gt;&lt;file name="amplify.yml"&gt;version: 1 frontend: phases: prebuild: commands: # ensure correct node yarn (berry) versions - nvm install 20 &amp;amp;&amp;amp; nvm use 20 - corepack enable - corepack prepare yarn@4.9.1 --activate - yarn --version # use yarn 4 immutable installs fast, deterministic builds ci - yarn install --immutable # remove existing keys, write single, up-to-date copy - sed '/^next_public_build_id=/d' .env.production 2&amp;gt;/dev/null || true - sed '/^next_telemetry_disabled=/d' .env.production 2&amp;gt;/dev/null || true - | { echo "next_public_build_id=${aws_commit_id:-$(date echo "next_telemetry_disabled=1" } &amp;gt;&amp;gt; .env.production build: commands: - echo "building next.js application..." - test -f scripts/generate-sw.mjs || { echo "generate-sw.mjs missing"; exit 1; } - node scripts/generate-sw.mjs - yarn build artifacts: basedirectory: .next files: - "**/*" cache: paths: - node_modules/**/* - .next/cache/**/* - .yarn/cache/**/* # static asset caching configured optimal performance. # security headers dynamic content managed middleware.ts. # static assets use long-lived caching; next.js hashed assets safe. customheaders: # service worker: avoid caching allow root scope - pattern: "/sw.js" headers: - key: cache-control value: "no-cache, no-store, must-revalidate" - key: service-worker-allowed value: "/" # next.js built assets - automatically hashed, safe long cache - pattern: "/_next/static/**" headers: - key: cache-control value: "public, max-age=31536000, immutable" # next.js optimized images - 1 year cache (critical performance) - pattern: "/_next/image*" headers: - key: cache-control value: "public, max-age=31536000, immutable" # css files - safe long cache; cache-busting handled deployment - pattern: "/styles/**" headers: - key: cache-control value: "public, max-age=31536000, immutable" - key: content-type value: "text/css; charset=utf-8" # font files - longer cache cors headers cross-origin loading - pattern: "/static/fonts/**" headers: - key: cache-control value: "public, max-age=31536000, immutable" - key: access-control-allow-origin value: "*" - key: cross-origin-resource-policy value: "cross-origin" # static assets - conservative since may use getversionedurl - pattern: "/static/**" headers: - key: cache-control value: "public, max-age=2592000" # 30 days # static images user uploads) - conservative approach # separate patterns common image extensions (brace expansion supported) - pattern: "/static/**/*.png" headers: - key: cache-control value: "public, max-age=2592000" # 30 days - pattern: "/static/**/*.jpg" headers: - key: cache-control value: "public, max-age=2592000" # 30 days - pattern: "/static/**/*.jpeg" headers: - key: cache-control value: "public, max-age=2592000" # 30 days - pattern: "/static/**/*.gif" headers: - key: cache-control value: "public, max-age=2592000" # 30 days - pattern: "/static/**/*.webp" headers: - key: cache-control value: "public, max-age=2592000" # 30 days - pattern: "/static/**/*.svg" headers: - key: cache-control value: "public, max-age=2592000" # 30 days - pattern: "/static/**/*.ico" headers: - key: cache-control value: "public, max-age=2592000" # 30 days # fonts - longer cache since rarely change (avoid brace expansion) - pattern: "/**/*.woff" headers: - key: cache-control value: "public, max-age=31536000" # 1 year - pattern: "/**/*.woff2" headers: - key: cache-control value: "public, max-age=31536000" # 1 year - pattern: "/**/*.ttf" headers: - key: cache-control value: "public, max-age=31536000" # 1 year - pattern: "/**/*.eot" headers: - key: cache-control value: "public, max-age=31536000" # 1 year # next.js pages - enable back/forward cache better performance # pattern matches html pages routes without file extensions - pattern: "/*" headers: - key: cache-control value: "public, max-age=0, s-maxage=3600, stale-while-revalidate=86400" # api routes - cors headers functionality (middleware excludes - pattern: "/api/**" headers: - key: access-control-allow-origin value: "https://esdeveniments.cat" - key: access-control-allow-methods value: "get,options,patch,delete,post,put" - key: access-control-allow-headers value: "x-csrf-token, x-requested-with, accept, accept-version, content-length, content-md5, content-type, date, x-api-version" - key: vary value: "origin" - key: cache-control value: "public, max-age=3600" # 1 hour - conservative api responses # environment variables set amplify console better security. # go app settings &amp;gt; environment variables # recommended variables: # node_env: production # next_telemetry_disabled: 1&lt;/file&gt;&lt;file name="jsconfig.json"&gt;{ "compileroptions": { "paths": { "@store": ["./store.js"], "@app/*": ["./app/*"], "@components/*": ["./components/*"], "@styles/*": ["./styles/*"], "@content/*": ["./content/*"], "@utils/*": ["./utils/*"], "@lib/*": ["./lib/*"], "@config/*": ["./config/*"], "@public/*": ["./public/*"], "@types/*": ["./types/*"] }, "types": ["./types/react-datepicker.d.ts", "./types/navigator.d.ts"] } }&lt;/file&gt;&lt;file name="middleware.ts"&gt;import { nextrequest, nextresponse } "next/server"; import { getapiorigin } "@utils/api-helpers"; import { validatetimestamp, buildstringtosign, verifyhmacsignature, } "@utils/hmac"; const isdev = process.env.node_env !== "production"; function getcsp(nonce: string) { const apiorigin = getapiorigin(); const cspdirectives = { "default-src": ["'self'"], "script-src": [ "'self'", `'nonce-${nonce}'`, "'strict-dynamic'", isdev ? "'unsafe-eval'" : "", isdev ? "localhost:*" : "", isdev ? "127.0.0.1:*" : "", ], "style-src": ["'self'", "'unsafe-inline'"], "connect-src": [ "'self'", apiorigin, "https:", isdev ? "wss:" : "", isdev ? "ws:" : "", isdev ? "localhost:*" : "", isdev ? "127.0.0.1:*" : "", ], // images: allow self, data uris, https everywhere; add blob previews // development, also allow http ease testing non-tls sources "img-src": [ "'self'", "data:", "https:", "blob:", isdev ? "http:" : "", ], "font-src": ["'self'"], "frame-src": ["'self'", "https:"], "worker-src": ["'self'", "blob:"], "object-src": ["'none'"], "base-uri": ["'self'"], "form-action": ["'self'"], "frame-ancestors": ["'self'"], }; return object.entries(cspdirectives) .map(([key, value]) =&amp;gt; `${key} ${value.filter(boolean).join(" ")}`) .join("; "); } export async function middleware(request: nextrequest) { const { pathname } = request.nexturl; (pathname.startswith("/api/")) { // allowlist public api routes require hmac browser ( pathname === "/api/regions/options" || pathname === "/api/promotions/config" || pathname === "/api/promotions/price-preview" || pathname === "/api/categories" || pathname === "/api/leads/restaurant" || pathname === "/api/stripe/checkout" || pathname === "/api/cloudinary/sign" || pathname === "/api/places/nearby" || pathname === "/api/places/photo" || // public proxy events list used client swr (get (pathname === "/api/events" &amp;amp;&amp;amp; request.method === "get") ) { return nextresponse.next(); } const hmac = request.headers.get("x-hmac"); const timestamp = request.headers.get("x-timestamp"); const contenttype = request.headers.get("content-type") || ""; let requestbody = ""; (!process.env.hmac_secret) { console.error("hmac_secret configured server."); return new nextresponse("internal server error", { status: 500 }); } (!contenttype.tolowercase().startswith("multipart/form-data")) { try { requestbody = await request.clone().text(); } catch (error) { console.error("could read request body middleware:", error); return new nextresponse("bad request: unable read request body", { status: 400, }); } } (!hmac || !timestamp) { return new nextresponse("unauthorized", { status: 401, }); } (!validatetimestamp(timestamp)) { return new nextresponse("unauthorized", { status: 401, }); } const stringtosign = buildstringtosign( requestbody, timestamp, pathname + request.nexturl.search, request.method ); const signatureisvalid = await verifyhmacsignature(stringtosign, hmac); (!signatureisvalid) { return new nextresponse(`unauthorized`, { status: 401, }); } return nextresponse.next(); } (pathname === "/sw.js") { const response = nextresponse.next(); response.headers.set( "cache-control", "no-cache, no-store, must-revalidate" ); response.headers.set("service-worker-allowed", "/"); return response; } const segments = pathname.split("/").filter(boolean); ( (segments.length === 3 || segments.length === 2) &amp;amp;&amp;amp; segments[1] === "tots" ) { const newpath = segments.length === 3 ? `/${segments[0]}/${segments[2]}` : `/${segments[0]}`; const searchparams = request.nexturl.searchparams.tostring(); const finalurl = searchparams ? `${newpath}?${searchparams}` : newpath; return nextresponse.redirect(new url(finalurl, request.url), 301); } const nonce = crypto.randomuuid(); const csp = getcsp(nonce); const requestheaders = new headers(request.headers); requestheaders.set("x-nonce", nonce); requestheaders.set("x-pathname", pathname); const response = nextresponse.next({ request: { headers: requestheaders, }, }); response.headers.set("content-security-policy", csp); response.headers.set( "strict-transport-security", "max-age=63072000; includesubdomains; preload" ); response.headers.set("x-content-type-options", "nosniff"); response.headers.set("x-frame-options", "sameorigin"); response.headers.set("referrer-policy", "strict-origin-when-cross-origin"); response.headers.set( "permissions-policy", "camera=(), microphone=(), geolocation=(self)" ); return response; } export const config = { matcher: [ "/((?!_next|favicon.ico|robots.txt|sitemap\\.xml|ads.txt|static|styles).*)", ], };&lt;/file&gt;&lt;file name="next-sitemap.config.js"&gt;const siteurl = process.env.node_env !== "production" ? "http://localhost:3000" : process.env.next_public_vercel_env === "preview" || process.env.next_public_vercel_env === "development" ? "https://esdeveniments.vercel.app" : "https://www.esdeveniments.cat"; module.exports = { siteurl, generatesitemap: true, exclude: [ "/api/*", // apis pages "/server-sitemap.xml", "/server-news-sitemap.xml", "/server-place-sitemap.xml", "/server-google-news-sitemap.xml", "/rss.xml", "/e/*", // event detail urls listed via dynamic server sitemap ], generaterobotstxt: true, robotstxtoptions: { policies: [ { useragent: "*", disallow: ["/404"] }, { useragent: "*", allow: "/" }, ], additionalsitemaps: [ `${siteurl}/server-sitemap.xml`, `${siteurl}/server-news-sitemap.xml`, `${siteurl}/server-place-sitemap.xml`, `${siteurl}/server-google-news-sitemap.xml`, ], }, };&lt;/file&gt;&lt;file name="next-sitemap.d.ts"&gt;declare module 'next-sitemap' { export const getserversidesitemaplegacy: export type isitemapfield = }&lt;/file&gt;&lt;file name="next.config.js"&gt;const { withsentryconfig } = require("@sentry/nextjs"); /** @type {import('next').nextconfig} */ const nextconfig = { // --- core settings --- reactstrictmode: true, poweredbyheader: false, compress: true, productionbrowsersourcemaps: false, // --- experimental features --- experimental: { scrollrestoration: true, reactcompiler: true, // react compiler experimental }, // --- optimizations --- compiler: { removeconsole: process.env.node_env === "production", }, // --- image optimization --- images: { // important: whitelist specific domains load images // using wildcards security risk. remotepatterns: [ { protocol: "https", hostname: "**" }, { protocol: "http", hostname: "**" }, ], devicesizes: [480, 640, 768, 1024, 1280, 1600, 1920], imagesizes: [16, 32, 48, 64, 96, 128, 256, 384], formats: ["image/avif", "image/webp"], minimumcachettl: 86400, }, // `headers` block removed. // security caching headers managed dynamically `middleware.ts`. // recommended approach implementing strict csp nonces. // --- redirects --- async redirects() { return []; }, }; // enable uploads auth token present. otherwise skip network calls avoid build failures. const sentryuploadsenabled = boolean(process.env.sentry_auth_token); const sentrywebpackpluginoptions = { silent: true, org: "esdeveniments", project: "javascript-nextjs", widenclientfileupload: true, transpileclientsdk: true, // prevent original sources appearing devtools production hidesourcemaps: true, // skip sentry network operations auth token configured (e.g., amplify/gha builds) dryrun: !sentryuploadsenabled, disablelogger: true, automaticvercelmonitors: true, }; module.exports = withsentryconfig(nextconfig, sentrywebpackpluginoptions);&lt;/file&gt;&lt;file name="package.json"&gt;{ "private": true, "scripts": { "analyze": "cross-env analyze=true next build", "analyze:server": "cross-env bundle_analyze=server next build", "analyze:browser": "cross-env bundle_analyze=browser next build", "vercel-build": "yarn run prebuild &amp;amp;&amp;amp; next build &amp;amp;&amp;amp; yarn run postbuild", "dev": "yarn run prebuild &amp;amp;&amp;amp; next dev", "build": "yarn run prebuild &amp;amp;&amp;amp; next build", "prebuild": "node scripts/generate-sw.mjs", "build:development": "node_env=development env-cmd -f .env.development yarn run prebuild &amp;amp;&amp;amp; env-cmd -f .env.development next build", "start:development": "env-cmd -f .env.development next start", "build:staging": "node_env=staging env-cmd -f .env.staging yarn run prebuild &amp;amp;&amp;amp; env-cmd -f .env.staging next build", "start:staging": "env-cmd -f .env.staging next start", "build:production": "node_env=production env-cmd -f .env.production yarn run prebuild &amp;amp;&amp;amp; env-cmd -f .env.production next build", "start:production": "node_env=production env-cmd -f .env.production next start", "postbuild": "next-sitemap", "start": "next start", "lint": "next lint", "typecheck": "tsc --noemit", "test": "vitest run", "test:watch": "vitest", "test:coverage": "vitest run --coverage", "test:e2e": "playwright test", "test:e2e:ui": "playwright test --ui", "test:e2e:debug": "playwright test --debug", "scan": "npx react-scan@latest localhost:3000" }, "dependencies": { "@headlessui/react": "^1.7.10", "@heroicons/react": "^1.0.6", "@sentry/nextjs": "^7.105.0", "@tailwindcss/aspect-ratio": "^0.4.2", "@tailwindcss/forms": "^0.5.3", "@tailwindcss/postcss": "^4.1.14", "@tailwindcss/typography": "^0.5.9", "autoprefixer": "^10.4.20", "axios": "^1.4.0", "cloudinary": "^2.7.0", "critters": "^0.0.25", "cssnano": "^7.0.6", "date-fns": "^2.29.3", "fast-xml-parser": "^4.4.0", "feed": "^4.2.2", "isomorphic-dompurify": "^2.25.0", "next": "^15.3.5", "postcss": "^8.5.1", "react": "^19.1.0", "react-datepicker": "^4.9.0", "react-dom": "^19.1.0", "react-select": "^5.7.0", "react-share": "^5.0.3", "react-tooltip": "^5.26.0", "swr": "^2.2.5", "tailwindcss": "^3.3.6", "zod": "3.24.3", "zustand": "^4.5.2" }, "devdependencies": { "@next/bundle-analyzer": "^13.1.6", "@playwright/test": "^1.48.0", "@testing-library/jest-dom": "^5.16.5", "@testing-library/react": "^14.0.0", "@testing-library/react-hooks": "^8.0.1", "@types/jest": "^30.0.0", "@types/jsdom": "^21.1.7", "@types/node": "^22.9.1", "@types/react": "^19.0.7", "@types/react-datepicker": "^7.0.0", "@types/react-dom": "^18.3.1", "@typescript-eslint/eslint-plugin": "^8.30.1", "@typescript-eslint/parser": "^8.30.1", "@vitejs/plugin-react": "^4.3.0", "babel-plugin-react-compiler": "^19.1.0-rc.1", "cross-env": "^7.0.3", "env-cmd": "^10.1.0", "eslint": "^8.57.0", "eslint-config-next": "^14.2.3", "eslint-plugin-react-hooks": "^6.0.0-rc.1", "jsdom": "^24.0.0", "next-sitemap": "^4.2.3", "prettier-eslint": "^15.0.1", "ts-node": "^10.9.2", "ttf2woff2": "^8.0.0", "typescript": "^5.6.3", "vite": "^5.4.0", "vite-tsconfig-paths": "^4.3.0", "vitest": "^1.6.0", "wait-on": "^8.0.4" }, "packagemanager": "yarn@4.9.1", "browserslist": [ "&amp;gt; 1%", "last 2 versions", dead", ie 11" ] }&lt;/file&gt;&lt;file name="playwright.config.ts"&gt;import { defineconfig, devices } "@playwright/test"; export default defineconfig({ testdir: "./e2e", fullyparallel: true, forbidonly: !!process.env.ci, retries: process.env.ci ? 2 : 0, workers: process.env.ci ? 1 : undefined, reporter: process.env.ci ? "blob" : [["list"], ["html", { open: "never" }]], use: { baseurl: process.env.playwright_test_base_url || "http://localhost:3000", navigationtimeout: 45000, trace: "on-first-retry", screenshot: "only-on-failure", video: "retain-on-failure", }, projects: [ { name: "chromium", use: { ...devices["desktop chrome"] }, }, ], webserver: { command: "e2e_test_mode=1 yarn dev", url: process.env.playwright_test_base_url || "http://localhost:3000", reuseexistingserver: true, timeout: 120000, }, expect: { timeout: 10000 }, // provide env app server (next.js) via process.env ci start step. // github actions set next_public_api_url; also export e2e_test_mode enable deterministic publish flow. });&lt;/file&gt;&lt;file name="playwright.remote.config.ts"&gt;import { defineconfig, devices } "@playwright/test"; // remote config run existing deployed url (e.g., amplify preview) // important: start local webserver const baseurl = process.env.playwright_test_base_url || "http://localhost:3000"; export default defineconfig({ testdir: "./e2e", fullyparallel: true, forbidonly: !!process.env.ci, retries: process.env.ci ? 2 : 0, workers: process.env.ci ? 1 : undefined, reporter: process.env.ci ? "blob" : [["list"], ["html", { open: "never" }]], use: { baseurl, navigationtimeout: 45000, trace: "on-first-retry", screenshot: "only-on-failure", video: "retain-on-failure", }, projects: [ { name: "chromium", use: { ...devices["desktop chrome"] }, }, ], expect: { timeout: 10000 }, });&lt;/file&gt;&lt;file name="postcss.config.js"&gt;module.exports = { plugins: { tailwindcss: {}, autoprefixer: {}, cssnano: { preset: "default" }, }, };&lt;/file&gt;&lt;file name="project-snapshot.txt"&gt;&amp;lt;?xml version='1.0' encoding='utf-8'?&amp;gt; &amp;lt;source type="github_repository"&amp;gt;&amp;lt;commit&amp;gt;unknown&amp;lt;/commit&amp;gt;&amp;lt;file name=".eslintrc.json"&amp;gt;{ "plugins": ["@typescript-eslint"], "extends": [ "eslint:recommended", "next", "next/core-web-vitals", "plugin:@typescript-eslint/recommended" ], "rules": { "no-unused-vars": "warn", "no-undef": "error", "no-debugger": "error", "react/react-in-jsx-scope": }, "env": { "es6": true, "browser": true, "node": true, "jest": true }, "overrides": [ { "files": ["public/sw.js", "public/sw-template.js"], "env": { "serviceworker": true }, "globals": { "workbox": "readonly", "importscripts": "readonly", "caches": "readonly", "self": "readonly" }, "rules": { "no-undef": } }, { "files": ["*.ts", "*.tsx"], "rules": { "no-undef": } }, { "files": [ "components/**/*.{ts,tsx,js,jsx}", "app/**/*.{ts,tsx,js,jsx}", "store.ts", "utils/**/*.{ts,tsx,js,jsx}" ], "rules": { "no-restricted-syntax": [ "error", { "selector": "tstypealiasdeclaration", "message": declare types outside /types directory. centralize type aliases /types." }, { "selector": "tsinterfacedeclaration", "message": declare interfaces outside /types directory. centralize interfaces /types." } ] } }, { "files": ["types/**/*.ts"], "rules": { "@typescript-eslint/no-unused-vars": "error", "no-restricted-syntax": [ "error", { "selector": "tsinterfacedeclaration[declaration.name='navigationitem']:not(:first-of-type)", "message": "navigationitem interface already defined. use canonical version types/common.ts." }, { "selector": "tsinterfacedeclaration[declaration.name='sociallinks']:not(:first-of-type)", "message": "sociallinks interface already defined. use canonical version types/common.ts." }, { "selector": "tsinterfacedeclaration[declaration.name='eventprops']:not(:first-of-type)", "message": "eventprops interface already defined. use canonical version types/common.ts." }, { "selector": "tsinterfacedeclaration[declaration.name='citysummaryresponsedto']:not(:first-of-type)", "message": "citysummaryresponsedto interface already defined. use canonical version types/api/city.ts." } ] } } ] }&amp;lt;/file&amp;gt;&amp;lt;file name=".yarnrc.yml"&amp;gt;nodelinker: node-modules yarnpath: .yarn/releases/yarn-4.9.1.cjs&amp;lt;/file&amp;gt;&amp;lt;file name="readme.md"&amp;gt;[next.js](https://nextjs.org/) project bootstrapped [`create-next-app`](https://github.com/vercel/next.js/tree/canary/packages/create-next-app). ## getting started first, run development server: ```bash npm run dev # yarn dev ``` open [http://localhost:3000](http://localhost:3000) browser see result. start editing page modifying `pages/index.js`. page auto-updates edit file. [api routes](https://nextjs.org/docs/api-routes/introduction) accessed [http://localhost:3000/api/hello](http://localhost:3000/api/hello). endpoint edited `pages/api/hello.js`. `pages/api` directory mapped `/api/*`. files directory treated [api routes](https://nextjs.org/docs/api-routes/introduction) instead react pages. ## learn learn next.js, take look following resources: - [next.js documentation](https://nextjs.org/docs) - learn next.js features api. - [learn next.js](https://nextjs.org/learn) - interactive next.js tutorial. check next.js github repository](https://github.com/vercel/next.js/) - feedback contributions welcome! ## deploy vercel easiest way deploy next.js app use [vercel platform](https://vercel.com/new?utm_medium=default-template&amp;amp;amp;filter=next.js&amp;amp;amp;utm_source=create-next-app&amp;amp;amp;utm_campaign=create-next-app-readme) creators next.js. check [next.js deployment documentation](https://nextjs.org/docs/deployment) details.&amp;lt;/file&amp;gt;&amp;lt;file name="amplify.yml"&amp;gt;version: 1 frontend: phases: prebuild: commands: # ensure correct node yarn (berry) versions - nvm install 20 &amp;amp;amp;&amp;amp;amp; nvm use 20 - corepack enable - corepack prepare yarn@4.9.1 --activate - yarn --version # use yarn 4 immutable installs fast, deterministic builds ci - yarn install --immutable # remove existing keys, write single, up-to-date copy - sed '/^next_public_build_id=/d' .env.production 2&amp;amp;gt;/dev/null || true - sed '/^next_telemetry_disabled=/d' .env.production 2&amp;amp;gt;/dev/null || true - | { echo "next_public_build_id=${aws_commit_id:-$(date echo "next_telemetry_disabled=1" } &amp;amp;gt;&amp;amp;gt; .env.production build: commands: - echo "building next.js application..." - test -f scripts/generate-sw.mjs || { echo "generate-sw.mjs missing"; exit 1; } - node scripts/generate-sw.mjs - yarn build artifacts: basedirectory: .next files: - "**/*" cache: paths: - node_modules/**/* - .next/cache/**/* - .yarn/cache/**/* # static asset caching configured optimal performance. # security headers dynamic content managed middleware.ts. # assets using getversionedurl() longer cache times. customheaders: # service worker: avoid caching allow root scope - pattern: "/sw.js" headers: - key: cache-control value: "no-cache, no-store, must-revalidate" - key: service-worker-allowed value: "/" # next.js built assets - automatically hashed, safe long cache - pattern: "/_next/static/**" headers: - key: cache-control value: "public, max-age=31536000, immutable" # next.js optimized images - 1 year cache (critical performance) - pattern: "/_next/image*" headers: - key: cache-control value: "public, max-age=31536000, immutable" # css files - safe long cache since /styles/non-critical.css uses getversionedurl - pattern: "/styles/**" headers: - key: cache-control value: "public, max-age=31536000, immutable" - key: content-type value: "text/css; charset=utf-8" # font files - longer cache cors headers cross-origin loading - pattern: "/static/fonts/**" headers: - key: cache-control value: "public, max-age=31536000, immutable" - key: access-control-allow-origin value: "*" - key: cross-origin-resource-policy value: "cross-origin" # static assets - conservative since may use getversionedurl - pattern: "/static/**" headers: - key: cache-control value: "public, max-age=2592000" # 30 days # static images user uploads) - conservative approach # separate patterns common image extensions (brace expansion supported) - pattern: "/static/**/*.png" headers: - key: cache-control value: "public, max-age=2592000" # 30 days - pattern: "/static/**/*.jpg" headers: - key: cache-control value: "public, max-age=2592000" # 30 days - pattern: "/static/**/*.jpeg" headers: - key: cache-control value: "public, max-age=2592000" # 30 days - pattern: "/static/**/*.gif" headers: - key: cache-control value: "public, max-age=2592000" # 30 days - pattern: "/static/**/*.webp" headers: - key: cache-control value: "public, max-age=2592000" # 30 days - pattern: "/static/**/*.svg" headers: - key: cache-control value: "public, max-age=2592000" # 30 days - pattern: "/static/**/*.ico" headers: - key: cache-control value: "public, max-age=2592000" # 30 days # fonts - longer cache since rarely change (avoid brace expansion) - pattern: "/**/*.woff" headers: - key: cache-control value: "public, max-age=31536000" # 1 year - pattern: "/**/*.woff2" headers: - key: cache-control value: "public, max-age=31536000" # 1 year - pattern: "/**/*.ttf" headers: - key: cache-control value: "public, max-age=31536000" # 1 year - pattern: "/**/*.eot" headers: - key: cache-control value: "public, max-age=31536000" # 1 year # next.js pages - enable back/forward cache better performance # pattern matches html pages routes without file extensions - pattern: "/*" headers: - key: cache-control value: "public, max-age=0, s-maxage=3600, stale-while-revalidate=86400" # api routes - cors headers functionality (middleware excludes - pattern: "/api/**" headers: - key: access-control-allow-origin value: "https://esdeveniments.cat" - key: access-control-allow-methods value: "get,options,patch,delete,post,put" - key: access-control-allow-headers value: "x-csrf-token, x-requested-with, accept, accept-version, content-length, content-md5, content-type, date, x-api-version" - key: vary value: "origin" - key: cache-control value: "public, max-age=3600" # 1 hour - conservative api responses # environment variables set amplify console better security. # go app settings &amp;amp;gt; environment variables # recommended variables: # node_env: production # next_telemetry_disabled: 1&amp;lt;/file&amp;gt;&amp;lt;file name="jsconfig.json"&amp;gt;{ "compileroptions": { "paths": { "@store": ["./store.js"], "@app/*": ["./app/*"], "@components/*": ["./components/*"], "@styles/*": ["./styles/*"], "@content/*": ["./content/*"], "@utils/*": ["./utils/*"], "@lib/*": ["./lib/*"], "@config/*": ["./config/*"], "@public/*": ["./public/*"], "@types/*": ["./types/*"] }, "types": ["./types/react-datepicker.d.ts", "./types/navigator.d.ts"] } }&amp;lt;/file&amp;gt;&amp;lt;file name="middleware.ts"&amp;gt;import { nextrequest, nextresponse } "next/server"; import { getapiorigin } "@utils/api-helpers"; import { validatetimestamp, buildstringtosign, verifyhmacsignature, } "@utils/hmac"; const isdev = process.env.node_env !== "production"; function getcsp(nonce: string) { const apiorigin = getapiorigin(); const cspdirectives = { "default-src": ["'self'"], "script-src": [ "'self'", `'nonce-${nonce}'`, "'strict-dynamic'", isdev ? "'unsafe-eval'" : "", isdev ? "localhost:*" : "", isdev ? "127.0.0.1:*" : "", ], "style-src": ["'self'", "'unsafe-inline'"], "connect-src": [ "'self'", apiorigin, "https:", isdev ? "wss:" : "", isdev ? "ws:" : "", isdev ? "localhost:*" : "", isdev ? "127.0.0.1:*" : "", ], "img-src": ["'self'", "data:", "https:"], "font-src": ["'self'"], "frame-src": ["'self'", "https:"], "worker-src": ["'self'", "blob:"], "object-src": ["'none'"], "base-uri": ["'self'"], "form-action": ["'self'"], "frame-ancestors": ["'self'"], }; return object.entries(cspdirectives) .map(([key, value]) =&amp;amp;gt; `${key} ${value.filter(boolean).join(" ")}`) .join("; "); } export async function middleware(request: nextrequest) { const { pathname } = request.nexturl; (pathname.startswith("/api/")) { const hmac = request.headers.get("x-hmac"); const timestamp = request.headers.get("x-timestamp"); const contenttype = request.headers.get("content-type") || ""; let requestbody = ""; (!process.env.hmac_secret) { console.error("hmac_secret configured server."); return new nextresponse("internal server error", { status: 500 }); } (!contenttype.tolowercase().startswith("multipart/form-data")) { try { requestbody = await request.clone().text(); } catch (error) { console.error("could read request body middleware:", error); return new nextresponse("bad request: unable read request body", { status: 400, }); } } (!hmac || !timestamp) { return new nextresponse("unauthorized", { status: 401, }); } (!validatetimestamp(timestamp)) { return new nextresponse("unauthorized", { status: 401, }); } const stringtosign = buildstringtosign( requestbody, timestamp, pathname + request.nexturl.search, request.method ); const signatureisvalid = await verifyhmacsignature(stringtosign, hmac); (!signatureisvalid) { return new nextresponse(`unauthorized`, { status: 401, }); } return nextresponse.next(); } (pathname === "/sw.js") { const response = nextresponse.next(); response.headers.set( "cache-control", "no-cache, no-store, must-revalidate" ); response.headers.set("service-worker-allowed", "/"); return response; } const segments = pathname.split("/").filter(boolean); ( (segments.length === 3 || segments.length === 2) &amp;amp;amp;&amp;amp;amp; segments[1] === "tots" ) { const newpath = segments.length === 3 ? `/${segments[0]}/${segments[2]}` : `/${segments[0]}`; const searchparams = request.nexturl.searchparams.tostring(); const finalurl = searchparams ? `${newpath}?${searchparams}` : newpath; return nextresponse.redirect(new url(finalurl, request.url), 301); } const nonce = crypto.randomuuid(); const csp = getcsp(nonce); const requestheaders = new headers(request.headers); requestheaders.set("x-nonce", nonce); requestheaders.set("x-pathname", pathname); const response = nextresponse.next({ request: { headers: requestheaders, }, }); response.headers.set("content-security-policy", csp); response.headers.set( "strict-transport-security", "max-age=63072000; includesubdomains; preload" ); response.headers.set("x-content-type-options", "nosniff"); response.headers.set("x-frame-options", "sameorigin"); response.headers.set("referrer-policy", "strict-origin-when-cross-origin"); response.headers.set( "permissions-policy", "camera=(), microphone=(), geolocation=(self)" ); return response; } export const config = { matcher: [ "/((?!_next|favicon.ico|robots.txt|sitemap\\.xml|ads.txt|static|styles).*)", ], };&amp;lt;/file&amp;gt;&amp;lt;file 