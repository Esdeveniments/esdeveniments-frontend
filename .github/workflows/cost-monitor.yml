name: AWS Cost Monitor

on:
  # Run once daily at 8 AM UTC - only sends email if anomaly detected
  # (CloudWatch alarms handle immediate alerting for spikes)
  schedule:
    - cron: "0 8 * * *"
  # Allow manual trigger (always sends report regardless of anomaly)
  workflow_dispatch:

# Note: Post-deploy monitoring is handled by CloudWatch alarms (immediate, 24/7)
# which send email alerts for:
#   - DynamoDB writes >100K/hour (catches searchParams issues)
#   - DynamoDB reads >500K/hour (catches cache thrashing)
#   - Lambda errors >10/min
#   - Lambda throttles >5/min
# This workflow provides daily cost summaries and trend analysis.

permissions:
  contents: read

env:
  AWS_REGION: "eu-west-3"

jobs:
  monitor-costs:
    name: Monitor AWS Costs
    runs-on: ubuntu-latest

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get current date info
        id: date
        run: |
          echo "today=$(date -u +%Y-%m-%d)" >> $GITHUB_OUTPUT
          echo "yesterday=$(date -u -d '1 day ago' +%Y-%m-%d)" >> $GITHUB_OUTPUT
          echo "month_start=$(date -u +%Y-%m-01)" >> $GITHUB_OUTPUT
          echo "month_name=$(date -u +%B)" >> $GITHUB_OUTPUT

      - name: Fetch monthly costs by service
        id: monthly_costs
        run: |
          echo "üìä Fetching ${{ steps.date.outputs.month_name }} costs..."

          COSTS=$(aws ce get-cost-and-usage \
            --time-period Start=${{ steps.date.outputs.month_start }},End=${{ steps.date.outputs.today }} \
            --granularity MONTHLY \
            --metrics "UnblendedCost" \
            --group-by Type=DIMENSION,Key=SERVICE \
            --output json)

          echo "costs<<EOF" >> $GITHUB_OUTPUT
          echo "$COSTS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Fetch DynamoDB writes (last 24h)
        id: dynamodb_writes
        run: |
          echo "üìä Fetching DynamoDB write metrics..."

          WRITES=$(aws cloudwatch get-metric-statistics \
            --namespace AWS/DynamoDB \
            --metric-name ConsumedWriteCapacityUnits \
            --dimensions Name=TableName,Value=esdeveniments-frontend-production-siteRevalidationTable-wxcxteaf \
            --start-time $(date -u -d '24 hours ago' +%Y-%m-%dT%H:%M:%SZ) \
            --end-time $(date -u +%Y-%m-%dT%H:%M:%SZ) \
            --period 3600 \
            --statistics Sum \
            --region ${{ env.AWS_REGION }} \
            --output json)

          echo "writes<<EOF" >> $GITHUB_OUTPUT
          echo "$WRITES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Fetch Lambda invocations (last 24h)
        id: lambda_invocations
        run: |
          echo "üìä Fetching Lambda metrics..."

          INVOCATIONS=$(aws cloudwatch get-metric-statistics \
            --namespace AWS/Lambda \
            --metric-name Invocations \
            --start-time $(date -u -d '24 hours ago' +%Y-%m-%dT%H:%M:%SZ) \
            --end-time $(date -u +%Y-%m-%dT%H:%M:%SZ) \
            --period 86400 \
            --statistics Sum \
            --region ${{ env.AWS_REGION }} \
            --output json)

          echo "invocations<<EOF" >> $GITHUB_OUTPUT
          echo "$INVOCATIONS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Analyze and report costs
        id: analysis
        run: |
          echo "## üìä AWS Cost Report - ${{ steps.date.outputs.today }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Parse monthly costs
          echo "### Monthly Costs (${{ steps.date.outputs.month_name }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Cost (USD) |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|------------|" >> $GITHUB_STEP_SUMMARY

          TOTAL_COST=0
          while IFS= read -r line; do
            SERVICE=$(echo "$line" | jq -r '.Keys[0]')
            COST=$(echo "$line" | jq -r '.Metrics.UnblendedCost.Amount')
            COST_NUM=$(echo "$COST" | awk '{printf "%.4f", $1}')
            
            # Skip services with essentially zero cost
            if (( $(echo "$COST_NUM > 0.0001 || $COST_NUM < -0.0001" | bc -l) )); then
              echo "| $SERVICE | \$${COST_NUM} |" >> $GITHUB_STEP_SUMMARY
              TOTAL_COST=$(echo "$TOTAL_COST + $COST_NUM" | bc -l)
            fi
          done < <(echo '${{ steps.monthly_costs.outputs.costs }}' | jq -c '.ResultsByTime[0].Groups[]')

          TOTAL_FORMATTED=$(printf "%.4f" $TOTAL_COST)
          echo "| **Total** | **\$${TOTAL_FORMATTED}** |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Parse DynamoDB writes
          echo "### DynamoDB Writes (Last 24h)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          TOTAL_WRITES=0
          MAX_HOURLY=0
          while IFS= read -r line; do
            WRITES=$(echo "$line" | jq -r '.Sum // 0')
            TOTAL_WRITES=$(echo "$TOTAL_WRITES + $WRITES" | bc)
            if (( $(echo "$WRITES > $MAX_HOURLY" | bc -l) )); then
              MAX_HOURLY=$WRITES
            fi
          done < <(echo '${{ steps.dynamodb_writes.outputs.writes }}' | jq -c '.Datapoints[]')

          echo "- **Total writes:** $(printf "%'d" $TOTAL_WRITES)" >> $GITHUB_STEP_SUMMARY
          echo "- **Max hourly:** $(printf "%'d" ${MAX_HOURLY%.*})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check for anomalies
          echo "### üö® Anomaly Detection" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          ANOMALY_DETECTED=false

          # Alert if DynamoDB writes > 100,000/hour (incident threshold)
          if (( $(echo "${MAX_HOURLY%.*} > 100000" | bc -l) )); then
            echo "‚ö†Ô∏è **HIGH DYNAMODB WRITES DETECTED!** Max hourly: $(printf "%'d" ${MAX_HOURLY%.*})" >> $GITHUB_STEP_SUMMARY
            echo "  - Threshold: 100,000/hour" >> $GITHUB_STEP_SUMMARY
            echo "  - Action: Check for searchParams usage in listing pages" >> $GITHUB_STEP_SUMMARY
            ANOMALY_DETECTED=true
          fi

          # Alert if daily writes > 60,000 (normal: 5-15K stable, 30-50K after deploys)
          # Note: Each deployment creates new cache namespace, requiring full cache warm-up
          if (( $(echo "$TOTAL_WRITES > 60000" | bc -l) )); then
            echo "‚ö†Ô∏è **Elevated DynamoDB writes:** $(printf "%'d" $TOTAL_WRITES) (threshold: 60,000/day)" >> $GITHUB_STEP_SUMMARY
            echo "  - Normal (stable cache): 5,000-15,000/day" >> $GITHUB_STEP_SUMMARY
            echo "  - After deployment: 30,000-50,000/day (cache warming)" >> $GITHUB_STEP_SUMMARY
            ANOMALY_DETECTED=true
          fi

          # Alert if monthly cost > $15 (healthy frontend baseline is ~$5-6/month)
          if (( $(echo "$TOTAL_COST > 15" | bc -l) )); then
            echo "‚ö†Ô∏è **Elevated monthly cost:** \$${TOTAL_FORMATTED} (baseline: ~\$5-6/month)" >> $GITHUB_STEP_SUMMARY
            ANOMALY_DETECTED=true
          fi

          if [ "$ANOMALY_DETECTED" = false ]; then
            echo "‚úÖ All metrics within normal ranges" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Frontend Baselines (Jan 2026)" >> $GITHUB_STEP_SUMMARY
          echo "- DynamoDB (ISR cache):" >> $GITHUB_STEP_SUMMARY
          echo "  - Stable cache: 5,000-15,000 writes/day" >> $GITHUB_STEP_SUMMARY
          echo "  - After deploy: 30,000-50,000 writes/day (cache warming)" >> $GITHUB_STEP_SUMMARY
          echo "  - Cost: ~\$1-3/month" >> $GITHUB_STEP_SUMMARY
          echo "- Lambda: ~\$0.03/month" >> $GITHUB_STEP_SUMMARY
          echo "- CloudFront: ~\$0.30/month" >> $GITHUB_STEP_SUMMARY
          echo "- S3 assets: ~\$3-4/month" >> $GITHUB_STEP_SUMMARY
          echo "- **Total frontend: ~\$5-8/month**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "_Note: Backend (Elastic Beanstalk in eu-west-1) costs ~\$54/month separately_" >> $GITHUB_STEP_SUMMARY

          # Set output for potential Slack/email notification
          echo "anomaly=$ANOMALY_DETECTED" >> $GITHUB_OUTPUT
          echo "total_cost=$TOTAL_FORMATTED" >> $GITHUB_OUTPUT
          echo "total_writes=$TOTAL_WRITES" >> $GITHUB_OUTPUT

      - name: Send alert via SNS (only on anomaly or manual trigger)
        if: steps.analysis.outputs.anomaly == 'true' || github.event_name == 'workflow_dispatch'
        env:
          AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
        run: |
          # Build email message
          if [ "${{ steps.analysis.outputs.anomaly }}" = "true" ]; then
            SUBJECT="‚ö†Ô∏è AWS Cost Alert - Anomaly Detected"
          else
            SUBJECT="‚úÖ AWS Cost Report (Manual) - ${{ steps.date.outputs.today }}"
          fi

          MESSAGE="AWS Frontend Cost Report - ${{ steps.date.outputs.today }}

          Monthly Cost: \$${{ steps.analysis.outputs.total_cost }}
          DynamoDB Writes (24h): ${{ steps.analysis.outputs.total_writes }}
          Status: $([ '${{ steps.analysis.outputs.anomaly }}' = 'true' ] && echo '‚ö†Ô∏è ANOMALY DETECTED' || echo '‚úÖ Normal')

          Frontend Baselines (eu-west-3):
          - DynamoDB: 5-15K/day stable, 30-50K after deploy (~\$1-3/month)
          - Lambda: ~\$0.03/month
          - CloudFront: ~\$0.30/month
          - Total frontend: ~\$5-8/month

          View full report: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          # Check if AWS_ACCOUNT_ID is set
          if [ -z "$AWS_ACCOUNT_ID" ]; then
            echo "‚ùå AWS_ACCOUNT_ID secret is not set. Please add it to repository secrets."
            echo "   Go to: Settings > Secrets and variables > Actions > New repository secret"
            exit 0
          fi

          TOPIC_ARN="arn:aws:sns:${{ env.AWS_REGION }}:${AWS_ACCOUNT_ID}:esdeveniments-frontend-production-SiteAlarms"
          echo "üìß Sending to SNS topic: $TOPIC_ARN"

          # Check if topic exists
          if ! aws sns get-topic-attributes --topic-arn "$TOPIC_ARN" --region ${{ env.AWS_REGION }} > /dev/null 2>&1; then
            echo "‚ùå SNS topic does not exist: $TOPIC_ARN"
            echo "   Create it with: aws sns create-topic --name esdeveniments-frontend-production-SiteAlarms"
            echo "   Then subscribe: aws sns subscribe --topic-arn <ARN> --protocol email --notification-endpoint your@email.com"
            exit 0
          fi

          # Send via SNS
          if aws sns publish \
            --topic-arn "$TOPIC_ARN" \
            --subject "$SUBJECT" \
            --message "$MESSAGE" \
            --region ${{ env.AWS_REGION }}; then
            echo "‚úÖ Email sent successfully via SNS"
          else
            echo "‚ùå Failed to publish to SNS. Check IAM permissions for sns:Publish"
          fi

      # Fallback: Send email via GitHub Action (works without AWS SNS)
      - name: Send email via SMTP (fallback, only on anomaly or manual trigger)
        if: (steps.analysis.outputs.anomaly == 'true' || github.event_name == 'workflow_dispatch') && env.SMTP_PASSWORD != ''
        env:
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
        uses: dawidd6/action-send-mail@v7
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: ${{ steps.analysis.outputs.anomaly == 'true' && '‚ö†Ô∏è AWS Cost Alert - Anomaly Detected' || format('‚úÖ AWS Daily Cost Report - {0}', steps.date.outputs.today) }}
          to: ${{ secrets.ALERT_EMAIL }}
          from: GitHub Actions <${{ secrets.SMTP_USERNAME }}>
          body: |
            AWS Cost Report - ${{ steps.date.outputs.today }}

            üìä Monthly Cost: $${{ steps.analysis.outputs.total_cost }}
            üìù DynamoDB Writes (24h): ${{ steps.analysis.outputs.total_writes }}
            üîî Status: ${{ steps.analysis.outputs.anomaly == 'true' && '‚ö†Ô∏è ANOMALY DETECTED' || '‚úÖ Normal' }}

            Baselines:
            - DynamoDB writes: 5-15K/day stable, 30-50K/day after deploy
            - Monthly cost: ~$5-8/month

            View full report: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
