name: Deploy to AWS (SST)

on:
  push:
    branches: [main]
  workflow_dispatch: # Allow manual trigger

concurrency:
  group: deploy-sst-${{ github.ref }}
  cancel-in-progress: false # Don't cancel - let deployments complete

# Explicit least-privilege permissions (security best practice)
permissions:
  contents: read
  actions: read

env:
  NODE_VERSION: "22"
  AWS_REGION: "eu-west-3"

jobs:
  deploy:
    name: Deploy to AWS with SST
    runs-on: ubuntu-latest
    timeout-minutes: 30
    # GitHub Environment enables protection rules, required reviewers, and environment-specific secrets
    environment:
      name: production
      url: https://www.esdeveniments.cat

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4 # Pin: b4ffde65f46336ab88eb53be808477a3936bae11

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4 # Pin: 39370e3970a6d050c480ffad4ff0ed4d3fdee5af
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: yarn

      - name: Enable Corepack (Yarn 4)
        run: corepack enable

      - name: Configure Yarn
        run: |
          yarn config set enableImmutableInstalls false

      - name: Install dependencies
        run: yarn install --immutable

      - name: Security audit
        run: yarn npm audit --all --recursive || true

      - name: Clean build artifacts
        run: |
          # Remove Next.js cache to prevent stale/malformed cached responses
          rm -rf .next
          # Remove SST artifacts from previous builds
          rm -rf .sst .open-next
          echo "‚úÖ Cleaned build artifacts"

      - name: Remove system Pulumi (use SST bundled version)
        run: |
          # SST 3.17.25 requires a newer Pulumi that supports the -root flag.
          # Remove any system-level Pulumi installation that might interfere.
          # SST will use its own bundled Pulumi binaries.
          sudo rm -f /usr/local/bin/pulumi* || true
          rm -rf ~/.pulumi/bin || true
          echo "‚úÖ Removed system Pulumi to ensure SST uses its bundled version"

      - name: Cache Next.js build cache
        uses: actions/cache@v5 # Pin: 0c45773b623bea8c8e75f6c82b208c3cf94ea4f9
        with:
          path: |
            ${{ github.workspace }}/.next/cache
          # Generate a new cache whenever packages or source files change.
          key: ${{ runner.os }}-nextjs-${{ hashFiles('**/yarn.lock') }}-${{ hashFiles('**/*.js', '**/*.jsx', '**/*.ts', '**/*.tsx') }}
          # If source files changed but packages didn't, rebuild from a prior cache.
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('**/yarn.lock') }}-

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4 # Pin: e3dd6a429d7300a6a4c196c26e071d42e0343502
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Create .env.production file for SST deployment
        env:
          # Optional secrets
          NEXT_PUBLIC_GOOGLE_ANALYTICS: ${{ secrets.NEXT_PUBLIC_GOOGLE_ANALYTICS }}
          NEXT_PUBLIC_GOOGLE_ADS: ${{ secrets.NEXT_PUBLIC_GOOGLE_ADS }}
          NEXT_PUBLIC_GOOGLE_MAPS: ${{ secrets.NEXT_PUBLIC_GOOGLE_MAPS }}
          NEXT_PUBLIC_GOOGLE_SITE_VERIFICATION: ${{ secrets.NEXT_PUBLIC_GOOGLE_SITE_VERIFICATION }}
          # Server-side runtime secrets
          GOOGLE_PLACES_API_KEY: ${{ secrets.GOOGLE_PLACES_API_KEY }}
          # Cache revalidation secrets (optional but recommended)
          REVALIDATE_SECRET: ${{ secrets.REVALIDATE_SECRET }}
          CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          # Required secrets (validated below)
          SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}
          HMAC_SECRET: ${{ secrets.HMAC_SECRET }}
          DEEPL_API_KEY: ${{ secrets.DEEPL_API_KEY }}
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          # Stripe secrets (required for sponsor payments)
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
          STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET }}
        run: |
          # Mask sensitive values in logs (defense in depth)
          echo "::add-mask::$HMAC_SECRET"
          echo "::add-mask::$NEXT_PUBLIC_API_URL"
          echo "::add-mask::$SENTRY_DSN"
          echo "::add-mask::$DEEPL_API_KEY"
          echo "::add-mask::$SENTRY_AUTH_TOKEN"
          echo "::add-mask::$REVALIDATE_SECRET"
          echo "::add-mask::$CLOUDFLARE_API_TOKEN"
          echo "::add-mask::$GOOGLE_PLACES_API_KEY"
          echo "::add-mask::$STRIPE_SECRET_KEY"
          echo "::add-mask::$STRIPE_WEBHOOK_SECRET"

          # Create .env.production for Next.js build (NODE_ENV=production)
          # Next.js loads .env.production when NODE_ENV=production
          touch .env.production

          # --- Validate and Set Required Secrets ---

          # 1. NEXT_PUBLIC_API_URL
          if [ -z "$NEXT_PUBLIC_API_URL" ]; then
            echo "::error::NEXT_PUBLIC_API_URL secret is required but not set in GitHub Secrets"
            exit 1
          fi
          echo "NEXT_PUBLIC_API_URL=$NEXT_PUBLIC_API_URL" >> .env.production

          # 2. HMAC_SECRET
          if [ -z "$HMAC_SECRET" ]; then
            echo "::error::HMAC_SECRET secret is required but not set in GitHub Secrets"
            exit 1
          fi
          echo "HMAC_SECRET=$HMAC_SECRET" >> .env.production

          # 3. SENTRY_DSN
          if [ -z "$SENTRY_DSN" ]; then
            echo "::error::SENTRY_DSN secret is required but not set in GitHub Secrets"
            exit 1
          fi
          echo "SENTRY_DSN=$SENTRY_DSN" >> .env.production

          # 4. DEEPL_API_KEY
          if [ -z "$DEEPL_API_KEY" ]; then
            echo "::error::DEEPL_API_KEY secret is required but not set in GitHub Secrets"
            exit 1
          fi
          echo "DEEPL_API_KEY=$DEEPL_API_KEY" >> .env.production

          # 5. STRIPE_SECRET_KEY (required for sponsor checkout)
          if [ -z "$STRIPE_SECRET_KEY" ]; then
            echo "::error::STRIPE_SECRET_KEY secret is required but not set in GitHub Secrets"
            exit 1
          fi
          echo "STRIPE_SECRET_KEY=$STRIPE_SECRET_KEY" >> .env.production

          # 6. STRIPE_WEBHOOK_SECRET (required for secure webhook handling - prevents bypass)
          if [ -z "$STRIPE_WEBHOOK_SECRET" ]; then
            echo "::error::STRIPE_WEBHOOK_SECRET secret is required but not set in GitHub Secrets"
            exit 1
          fi
          echo "STRIPE_WEBHOOK_SECRET=$STRIPE_WEBHOOK_SECRET" >> .env.production

          # --- Set Optional/Static Variables ---

          # Set NEXT_PUBLIC_SITE_URL for build-time sitemap generation
          echo "NEXT_PUBLIC_SITE_URL=https://www.esdeveniments.cat" >> .env.production

          # SENTRY_AUTH_TOKEN (Required for source map uploads, but we don't fail deployment if missing, just warn/skip in config)
          if [ -n "$SENTRY_AUTH_TOKEN" ]; then
            echo "SENTRY_AUTH_TOKEN=$SENTRY_AUTH_TOKEN" >> .env.production
          else
             echo "::warning::SENTRY_AUTH_TOKEN is not set. Source maps will not be uploaded."
          fi

          if [ -n "$NEXT_PUBLIC_GOOGLE_ANALYTICS" ]; then
            echo "NEXT_PUBLIC_GOOGLE_ANALYTICS=$NEXT_PUBLIC_GOOGLE_ANALYTICS" >> .env.production
          fi

          if [ -n "$NEXT_PUBLIC_GOOGLE_ADS" ]; then
            echo "NEXT_PUBLIC_GOOGLE_ADS=$NEXT_PUBLIC_GOOGLE_ADS" >> .env.production
          fi

          if [ -n "$NEXT_PUBLIC_GOOGLE_MAPS" ]; then
            echo "NEXT_PUBLIC_GOOGLE_MAPS=$NEXT_PUBLIC_GOOGLE_MAPS" >> .env.production
          fi

          if [ -n "$NEXT_PUBLIC_GOOGLE_SITE_VERIFICATION" ]; then
            echo "NEXT_PUBLIC_GOOGLE_SITE_VERIFICATION=$NEXT_PUBLIC_GOOGLE_SITE_VERIFICATION" >> .env.production
          fi

          # Server-side runtime secrets
          if [ -n "$GOOGLE_PLACES_API_KEY" ]; then
            echo "GOOGLE_PLACES_API_KEY=$GOOGLE_PLACES_API_KEY" >> .env.production
          fi

          # Cache revalidation secrets (optional)
          if [ -n "$REVALIDATE_SECRET" ]; then
            echo "REVALIDATE_SECRET=$REVALIDATE_SECRET" >> .env.production
            echo "‚úÖ REVALIDATE_SECRET configured"
          else
            echo "::warning::REVALIDATE_SECRET not set. /api/revalidate endpoint will reject all requests."
          fi

          if [ -n "$CLOUDFLARE_ZONE_ID" ]; then
            echo "CLOUDFLARE_ZONE_ID=$CLOUDFLARE_ZONE_ID" >> .env.production
          fi

          if [ -n "$CLOUDFLARE_API_TOKEN" ]; then
            echo "CLOUDFLARE_API_TOKEN=$CLOUDFLARE_API_TOKEN" >> .env.production
          fi

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Generate service worker and robots.txt (prebuild)
        env:
          BUILD_VERSION: ${{ github.sha }}
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}
          NEXT_PUBLIC_SITE_URL: https://www.esdeveniments.cat
        run: yarn prebuild

      - name: Build Next.js application
        run: yarn build
        env:
          NODE_ENV: production

      - name: Start Next.js server (background)
        run: |
          yarn start &
          echo $! > .next-server.pid
          echo "Started Next.js server with PID $(cat .next-server.pid)"
        env:
          NODE_ENV: production
          PORT: 3000
          E2E_TEST_MODE: "1"
          NEXT_PUBLIC_E2E_TEST_MODE: "1"

      - name: Wait for server to be ready
        run: npx wait-on http://localhost:3000 --timeout 60000

      - name: Sanity check robots.txt
        run: |
          set -euo pipefail
          robots="$(curl -fsS http://localhost:3000/robots.txt)"
          echo "$robots" | grep -F -i "allow: /" > /dev/null
          echo "$robots" | grep -F -i "disallow: /_next/" > /dev/null
          echo "$robots" | grep -F -i "disallow: /api/" > /dev/null
          echo "$robots" | grep -F -i "user-agent: gptbot" > /dev/null
          echo "$robots" | grep -F -i "sitemap: https://www.esdeveniments.cat/server-static-sitemap.xml" > /dev/null
          echo "‚úÖ robots.txt looks correct"

      - name: Run E2E tests
        run: yarn test:e2e -c playwright.remote.config.ts --workers=2
        env:
          CI: true
          PLAYWRIGHT_TEST_BASE_URL: http://localhost:3000

      - name: Stop Next.js server
        if: always()
        run: |
          if [ -f .next-server.pid ]; then
            kill $(cat .next-server.pid) || true
            rm .next-server.pid
          fi
          pkill -f "yarn start" || true

      - name: Upload Playwright report (on failure)
        if: failure()
        uses: actions/upload-artifact@v4 # Pin: 6f51ac03b9356f520e9adb1b1b7802705f340c2b
        with:
          name: playwright-report-deploy
          path: playwright-report/
          retention-days: 7
          if-no-files-found: ignore

      - name: Log SST and OpenNext versions
        run: |
          echo "üì¶ SST version: $(cat node_modules/sst/package.json | jq -r '.version')"
          echo "üì¶ OpenNext version: $(cat node_modules/open-next/package.json | jq -r '.version')"

      - name: Preview SST infrastructure changes
        env:
          AWS_REGION: ${{ env.AWS_REGION }}
          NODE_ENV: production
        run: npx sst diff --stage production || true

      - name: Deploy to AWS with SST
        env:
          AWS_REGION: ${{ env.AWS_REGION }}
          NODE_ENV: production
          # Required for CloudFront invalidation IAM permissions
          AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
        run: npx sst deploy --stage production

      - name: Post-deploy verification
        if: success()
        env:
          REVALIDATE_SECRET: ${{ secrets.REVALIDATE_SECRET }}
        run: |
          echo "‚è≥ Waiting for CloudFront propagation..."
          sleep 30

          # Smoke tests
          echo "üß™ Running smoke tests..."
          curl -sf --max-time 10 https://www.esdeveniments.cat/ > /dev/null && echo "‚úÖ Homepage OK" || echo "::warning::Homepage slow/unavailable"
          curl -sf --max-time 10 https://www.esdeveniments.cat/barcelona > /dev/null && echo "‚úÖ Barcelona page OK" || echo "::warning::Barcelona page slow/unavailable"
          curl -sf --max-time 5 https://www.esdeveniments.cat/robots.txt | grep -q "Sitemap:" && echo "‚úÖ robots.txt OK" || echo "::warning::robots.txt issue"

          # CloudFront check
          echo "üåê Checking CloudFront..."
          curl -sI https://www.esdeveniments.cat 2>/dev/null | grep -qi "x-cache" && echo "‚úÖ CloudFront serving" || echo "::warning::CloudFront cache header not found"

          # Health check
          echo "üîç Checking deployment health..."
          HTTP_CODE=$(curl -s -o /tmp/health.json -w "%{http_code}" "https://www.esdeveniments.cat/api/health?secret=${REVALIDATE_SECRET}" || echo "000")
          echo "Health endpoint: HTTP $HTTP_CODE"
          if [ -f /tmp/health.json ]; then
            S3_OK=$(jq -r '.cache.s3.configured // false' /tmp/health.json)
            DYNAMO_OK=$(jq -r '.cache.dynamodb.configured // false' /tmp/health.json)
            [ "$S3_OK" = "true" ] && [ "$DYNAMO_OK" = "true" ] && echo "‚úÖ Cache infrastructure OK" || echo "::warning::Cache may need: npx sst refresh --stage production"
          fi

          echo "‚úÖ Post-deploy verification complete"

      - name: Deployment summary
        if: success()
        run: |
          echo "‚úÖ Deployment completed successfully!"
          echo "üåç Site URL: https://esdeveniments.cat"
          echo "üìä Check AWS Console: https://console.aws.amazon.com/cloudfront/home?region=${{ env.AWS_REGION }}"
