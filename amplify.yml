version: 1
frontend:
  phases:
    preBuild:
      commands:
        - echo "Installing dependencies..."
        - yarn install --frozen-lockfile
        - echo "NEXT_PUBLIC_BUILD_ID=${AWS_COMMIT_ID:-$(date +%s)}" >> .env.production
    build:
      commands:
        - echo "Building Next.js application..."
        - yarn build
  artifacts:
    baseDirectory: .next
    files:
      - "**/*"
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*
      - .yarn/cache/**/*
  customHeaders:
    # CSS files - 1 year cache
    - pattern: "/styles/**"
      headers:
        - key: "Cache-Control"
          value: "public, max-age=31536000, immutable"
        - key: "Content-Type"
          value: "text/css; charset=utf-8"

    # Font files - 1 year cache
    - pattern: "/static/fonts/**"
      headers:
        - key: "Cache-Control"
          value: "public, max-age=31536000, immutable"
        - key: "Access-Control-Allow-Origin"
          value: "*"
        - key: "Cross-Origin-Resource-Policy"
          value: "cross-origin"

    # Static assets - 1 year cache
    - pattern: "/static/**"
      headers:
        - key: "Cache-Control"
          value: "public, max-age=31536000, immutable"

    # Next.js static assets - 1 year cache
    - pattern: "/_next/static/**"
      headers:
        - key: "Cache-Control"
          value: "public, max-age=31536000, immutable"

    # Next.js optimized images - 1 year cache
    - pattern: "/_next/image**"
      headers:
        - key: "Cache-Control"
          value: "public, max-age=31536000, immutable"

    # Service Worker - no cache
    - pattern: "/sw.js"
      headers:
        - key: "Cache-Control"
          value: "no-cache, no-store, must-revalidate"
        - key: "Content-Type"
          value: "application/javascript; charset=utf-8"
        - key: "Service-Worker-Allowed"
          value: "/"

    # API routes - appropriate caching
    - pattern: "/api/**"
      headers:
        - key: "Access-Control-Allow-Origin"
          value: "https://esdeveniments.cat"
        - key: "Access-Control-Allow-Methods"
          value: "GET,OPTIONS,PATCH,DELETE,POST,PUT"
        - key: "Access-Control-Allow-Headers"
          value: "X-CSRF-Token, X-Requested-With, Accept, Accept-Version, Content-Length, Content-MD5, Content-Type, Date, X-Api-Version"

    # Security headers for all pages
    - pattern: "**"
      headers:
        - key: "X-DNS-Prefetch-Control"
          value: "on"
        - key: "Strict-Transport-Security"
          value: "max-age=63072000; includeSubDomains; preload"
        - key: "Content-Security-Policy"
          value: "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https: http:; style-src 'self' 'unsafe-inline' https:; font-src 'self' https:; img-src 'self' data: https: http:; connect-src 'self' https:; frame-src 'self' https:; worker-src 'self' blob:"
        - key: "X-Frame-Options"
          value: "SAMEORIGIN"
        - key: "X-Content-Type-Options"
          value: "nosniff"
        - key: "Referrer-Policy"
          value: "origin-when-cross-origin"
        - key: "Permissions-Policy"
          value: "camera=(), microphone=(), geolocation=()"

# Environment variables for build optimization
environment:
  variables:
    NODE_ENV: production
    NEXT_TELEMETRY_DISABLED: 1
    # Enable build optimizations
    NEXT_PRIVATE_STANDALONE: true
